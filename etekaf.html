<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø§Ø¯Ù…Ø§Ù† Ø§Ø¹ØªÚ©Ø§Ù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    <!-- ÙØ§ÛŒÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª API - Ø¨Ø§ÛŒØ¯ Ø§Ø² build-config.js ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯ -->
    <script src="config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0891b2', // ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ Ø®Ø§Øµ (Cyan-600)
                        'primary-hover': '#0e7490',
                        'soft-bg': '#f0f9ff',
                    },
                    borderRadius: {
                        'gg': '1.5rem', // Googooli Radius
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            color: #334155;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .timeline-container { position: relative; padding-right: 24px; }
        .timeline-line { position: absolute; top: 16px; bottom: 0; right: 10px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-dot { width: 12px; height: 12px; background: #fff; border: 3px solid #94a3b8; border-radius: 50%; position: absolute; right: -20px; top: 8px; z-index: 1; transition: all 0.2s; }
        .timeline-dot.ai { border-color: #f59e0b; background: #fef3c7; }
        .timeline-dot.user { border-color: #0891b2; background: #cffafe; }

        .protocol-card { border-right: 4px solid; background: #fff; margin-bottom: 1rem; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); overflow: hidden; }
        
        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
        .persian-num { font-feature-settings: "ss01"; }
        
        /* Micro-animation for clicks */
        .btn-press:active { transform: scale(0.92); transition: transform 0.1s; }
    </style>
</head>
<body class="bg-soft-bg min-h-screen selection:bg-cyan-100">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 border-b border-cyan-100">
        <div class="max-w-md mx-auto px-5 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-primary text-white p-2.5 rounded-2xl shadow-lg shadow-cyan-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </div>
                <div>
                    <h1 class="font-black text-slate-700 text-lg tracking-tight">ÛŒØ§ÙˆØ± Ù…Ø±Ø¨ÛŒ</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-[11px] text-slate-400 font-bold">Ø§Ø¹ØªÚ©Ø§Ù ÛŒØ§Ø±Ø§Ù† Ù…ÙˆØ¹ÙˆØ¯</span>
                    </div>
                </div>
            </div>
            <button onclick="openSettingsModal()" class="btn-press p-3 text-slate-400 hover:text-primary transition-colors rounded-full hover:bg-cyan-50" title="Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ø®Ø§Ø¯Ù…">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="max-w-md mx-auto w-full p-5 relative min-h-[calc(100vh-140px)]"></main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)] z-40 rounded-t-3xl">
        <div class="max-w-md mx-auto grid grid-cols-3 h-20 items-center pb-2">
            <button onclick="router('home')" id="nav-home" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-800">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ø³Ù†Ú¯Ø± ÙØ±Ù‡Ù†Ú¯ÛŒ</span>
            </button>
            <button onclick="router('schedule')" id="nav-schedule" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ù†Ø¸Ù… Ùˆ Ø¬Ù‡Ø§Ø¯</span>
            </button>
            <button onclick="router('profiles')" id="nav-profiles" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§</span>
            </button>
        </div>
    </nav>

    <!-- General Modal (Click outside to close) -->
    <div id="modal-overlay" onclick="if(event.target === this) closeModal()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] z-50 hidden flex items-center justify-center transition-all duration-300 px-4 pb-4 sm:pb-0">
        <div id="modal-card" class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl transform scale-95 opacity-0 transition-all duration-300 max-h-[85vh] flex flex-col relative overflow-hidden">
            <!-- Modal content -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md text-white px-6 py-3.5 rounded-2xl shadow-xl text-sm font-medium z-[60] flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 scale-90 border border-slate-700/50">
        <span class="text-xl">ğŸ•Šï¸</span>
        <span id="toast-msg">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</span>
    </div>

    <script>
        // --- CONFIG ---
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„ config.js Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const config = window.APP_CONFIG || {
            apiKey: "",
            baseUrl: "https://selfclaude.flearning.ir/",
            apiEndpoint: "chat/completions",
            promptsUrl: "https://opensheet.elk.sh/1yxTX1rxNpJ_HDDLxpgi4CmqIJ3S3uZgII9phrjUl_uY/Sheet1" // URL Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet
        };
        
        const apiKey = config.apiKey;
        const baseUrl = config.baseUrl;
        const apiEndpoint = config.apiEndpoint;

        // --- SAFE API CALLER ---
        async function callGemini(userPrompt, systemInstruction) {
            if (!apiKey) {
                console.warn("API key not configured.");
                await new Promise(r => setTimeout(r, 600));
                return JSON.stringify({
                    diagnosis: "Ø­Ø§Ù„Øª ØªÙ…Ø±ÛŒÙ†ÛŒ: Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡",
                    action: "Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ú©Ù„ÛŒØ¯ API Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.",
                    ammo: "Ø­Ø¯ÛŒØ«: Ø§Ù†ØªØ¸Ø§Ø± ÙØ±Ø¬ØŒ Ø§ÙØ¶Ù„ Ø§Ø¹Ù…Ø§Ù„ Ø§Ø³Øª.",
                    targeting: "Ù‡Ù…Ù‡ ÛŒØ§Ø±Ø§Ù† Ø±Ø§ ÙØ±Ø§Ø®ÙˆØ§Ù† Ú©Ù†ÛŒØ¯.",
                    sentiment: "Ù†Ø§Ù…Ø´Ø®Øµ",
                    advice: "Ø³ÛŒØ³ØªÙ… Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª."
                });
            }

            // Ø³Ø§Ø®Øª URL Ú©Ø§Ù…Ù„
            const url = `${baseUrl}${apiEndpoint}`.replace(/\/+/g, '/').replace(/^https?:\//, 'https://');
            
            // ÙØ±Ù…Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ API Ø¬Ø¯ÛŒØ¯ (Ù…Ø´Ø§Ø¨Ù‡ Claude/ChatGPT)
            const payload = {
                messages: [
                    { role: "system", content: systemInstruction },
                    { role: "user", content: userPrompt }
                ]
            };

            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                            // Ø§Ú¯Ø± Ø¨Ú©â€ŒØ§Ù†Ø¯ Ø§Ø² header Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø§ÛŒÙ†Ø¬Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
                            // Ù…Ø«Ù„Ø§Ù‹: 'api-key': apiKey ÛŒØ§ 'X-API-Key': apiKey
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', response.status, errorText);
                        throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    
                    // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ù¾Ø§Ø³Ø® Ø¯Ø± ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                    const responseText = data.choices?.[0]?.message?.content || 
                                       data.content || 
                                       data.response || 
                                       data.message || 
                                       data.text ||
                                       (data.choices && data.choices[0]?.text) ||
                                       JSON.stringify(data);
                    
                    return responseText;
                } catch (error) {
                    if (i === delays.length) {
                        console.error("API Failure:", error);
                        throw error;
                    }
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // --- DEFAULT DATA ---
        const DEFAULT_PROMPTS = {
            mentorProtocol: `Ø´Ù…Ø§ "Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø§Ø¯Ù…Ø§Ù† Ø§Ø¹ØªÚ©Ø§Ù" Ù‡Ø³ØªÛŒØ¯. Ø§Ø¯Ø¨ÛŒØ§Øª Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø³ÛŒØ§Ø± ØµÙ…ÛŒÙ…ÛŒØŒ Ø¬Ù‡Ø§Ø¯ÛŒ Ùˆ Ù…Ø¹Ù†ÙˆÛŒ Ø¨Ø§Ø´Ø¯.
Ø®Ø±ÙˆØ¬ÛŒ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÛŒÚ© JSON Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ diagnosis, action, ammo, targeting Ø¨Ø§Ø´Ø¯.
ÙÙ‚Ø· JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† Markdown.`,
            profileAnalysis: `Ø´Ù…Ø§ "Ù…Ø´Ø§ÙˆØ± ØªØ±Ø¨ÛŒØªÛŒ" Ø¯Ø± ÙØ¶Ø§ÛŒ Ø§Ø¹ØªÚ©Ø§Ù Ù‡Ø³ØªÛŒØ¯. Ù„Ø­Ù† Ø¯Ù„Ø³ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ù…Ø±Ø¨ÛŒâ€ŒÚ¯ÙˆÙ†Ù‡. Ø®Ø±ÙˆØ¬ÛŒ JSON Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ sentiment Ùˆ advice.
ÙÙ‚Ø· JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† Markdown.`
        };

        const DEFAULT_SCHEDULE = [
            { id: 1, time: "03:30", title: "Ù…Ù†Ø§Ø¬Ø§Øª Ø¨Ø§ Ù‚Ø§Ø¶ÛŒâ€ŒØ§Ù„Ø­Ø§Ø¬Ø§Øª (Ø³Ø­Ø±)" },
            { id: 2, time: "04:15", title: "Ø±Ø²Ù‚ Ø³Ø­Ø±ÛŒ" },
            { id: 3, time: "05:25", title: "Ù†Ù…Ø§Ø² ØµØ¨Ø­ (Ø¬Ù…Ø§Ø¹Øª)" },
            { id: 4, time: "06:00", title: "Ø¹Ù‡Ø¯ Ø¨Ø§ Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† (Ø¹Ø¬)" },
            { id: 5, time: "10:30", title: "Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø±ÙØª: Ø±ÙØ§Ù‚Øª Ø¨Ø§ Ø®Ø¯Ø§" },
            { id: 6, time: "12:15", title: "Ù†Ù…Ø§Ø² Ø¬Ù…Ø§Ø¹Øª Ø¸Ù‡Ø± Ùˆ Ø¹ØµØ±" },
            { id: 7, time: "13:30", title: "Ø®ÙˆØ§Ø¨ Ù‚ÛŒÙ„ÙˆÙ„Ù‡ (ØªØ¬Ø¯ÛŒØ¯ Ù‚ÙˆØ§)" },
            { id: 8, time: "16:00", title: "Ú¯Ø¹Ø¯Ù‡ ØµÙ…ÛŒÙ…Ø§Ù†Ù‡ Ø¹ØµØ±" },
            { id: 9, time: "17:30", title: "Ø®Ù„ÙˆØª Ø¨Ø§ Ù‚Ø±Ø¢Ù†" },
            { id: 10, time: "18:20", title: "Ù†Ù…Ø§Ø² Ù…ØºØ±Ø¨ Ùˆ Ø¹Ø´Ø§Ø¡" },
            { id: 11, time: "19:00", title: "Ø³ÙØ±Ù‡ Ø§ÙØ·Ø§Ø±" },
            { id: 12, time: "21:00", title: "Ù‡ÛŒØ¦Øª Ùˆ ØªÙˆØ³Ù„" },
            { id: 13, time: "23:00", title: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª" }
        ];

        const DEFAULT_PROFILES = [
            {
                name: "Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ†", age: 14,
                logs: [
                    { time: "04:30", note: "Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÛŒÙ‡ Ùˆ ØªÙˆØ³Ù„ Ø¨ÙˆØ¯ØŒ Ø­Ø§Ù„ Ù…Ø¹Ù†ÙˆÛŒ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´Øª.", type: 'user' },
                    { time: "11:00", note: "Ú©Ù…ÛŒ Ú©Ø³Ù„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ø´Ø±Ú©Øª Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.", type: 'user' }
                ]
            }
        ];

        // --- STATE ---
        let state = {
            prompts: JSON.parse(localStorage.getItem('prompts')) || DEFAULT_PROMPTS,
            schedule: JSON.parse(localStorage.getItem('schedule')) || DEFAULT_SCHEDULE,
            profiles: JSON.parse(localStorage.getItem('profiles')) || DEFAULT_PROFILES
        };
        let confirmCallback = null;

        // --- FETCH PROMPTS FROM URL ---
        let fetchPromptsPromise = null; // Promise Ø¨Ø±Ø§ÛŒ fetch
        
        async function fetchPromptsFromUrl() {
            const promptsUrl = config.promptsUrl;
            if (!promptsUrl) {
                console.log('No prompts URL configured, using defaults');
                return Promise.resolve();
            }

            try {
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† timestamp Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² cache
                const urlWithCacheBuster = `${promptsUrl}?t=${Date.now()}`;
                const response = await fetch(urlWithCacheBuster, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const sheetData = await response.json();
                
                // ØªØ¨Ø¯ÛŒÙ„ <br> Ø¨Ù‡ Ø®Ø· Ø¬Ø¯ÛŒØ¯
                const convertBrToNewline = (text) => {
                    if (!text) return '';
                    return String(text).replace(/<br\s*\/?>/gi, '\n');
                };
                
                // OpenSheet ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø² Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                // Ù‡Ø± Ø±Ø¯ÛŒÙ ÛŒÚ© Ø´ÛŒØ¡ Ø§Ø³Øª Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ type, mentorProtocol, profileAnalysis
                if (Array.isArray(sheetData) && sheetData.length > 0) {
                    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ø¨Ø§ type = "System Instruction" (case-insensitive)
                    const systemInstructionRow = sheetData.find(row => 
                        row.type && String(row.type).trim().toLowerCase() === 'system instruction'
                    );
                    
                    if (systemInstructionRow) {
                        let updated = false;
                        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§
                        if (systemInstructionRow.mentorProtocol) {
                            state.prompts.mentorProtocol = convertBrToNewline(systemInstructionRow.mentorProtocol);
                            updated = true;
                        }
                        if (systemInstructionRow.profileAnalysis) {
                            state.prompts.profileAnalysis = convertBrToNewline(systemInstructionRow.profileAnalysis);
                            updated = true;
                        }
                        
                        if (updated) {
                            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                            saveData();
                            console.log('âœ… Prompts fetched and updated successfully from Google Sheet');
                            // Ø§Ú¯Ø± modal ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
                            const modalCard = document.getElementById('modal-card');
                            if (modalCard && modalCard.innerHTML.includes('set-prompt-main')) {
                                openSettingsModal();
                            }
                        }
                    } else {
                        // Ø§Ú¯Ø± Ø±Ø¯ÛŒÙ System Instruction Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø±Ø¯ÛŒÙ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…
                        const firstRow = sheetData[0];
                        if (firstRow && (firstRow.mentorProtocol || firstRow.profileAnalysis)) {
                            let updated = false;
                            if (firstRow.mentorProtocol) {
                                state.prompts.mentorProtocol = convertBrToNewline(firstRow.mentorProtocol);
                                updated = true;
                            }
                            if (firstRow.profileAnalysis) {
                                state.prompts.profileAnalysis = convertBrToNewline(firstRow.profileAnalysis);
                                updated = true;
                            }
                            if (updated) {
                                saveData();
                                console.log('âš ï¸ System Instruction row not found, used first row instead');
                                // Ø§Ú¯Ø± modal ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
                                const modalCard = document.getElementById('modal-card');
                                if (modalCard && modalCard.innerHTML.includes('set-prompt-main')) {
                                    openSettingsModal();
                                }
                            }
                        } else {
                            console.warn('âŒ System Instruction row not found and first row is invalid');
                        }
                    }
                } else {
                    console.warn('âŒ Invalid sheet data format - expected array');
                }
            } catch (error) {
                console.warn('Failed to fetch prompts from URL, using defaults:', error);
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        fetchPromptsPromise = fetchPromptsFromUrl(); 

        function saveData() {
            localStorage.setItem('prompts', JSON.stringify(state.prompts));
            localStorage.setItem('schedule', JSON.stringify(state.schedule));
            localStorage.setItem('profiles', JSON.stringify(state.profiles));
        }

        function toPersianDigits(input) {
            const str = String(input || '');
            return str.replace(/[0-9]/g, c => String.fromCharCode(c.charCodeAt(0) + 1728));
        }

        function timeToMinutes(t) {
            if (!t) return 0;
            const [h, m] = String(t).split(':').map(x => parseInt(x, 10) || 0);
            return h * 60 + m;
        }

        function router(route) {
            window.scrollTo(0,0);
            document.querySelectorAll('.nav-item').forEach(el => {
                el.className = "nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400 transition-colors";
            });
            const navEl = document.getElementById(`nav-${route}`);
            if (navEl) navEl.className = "nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-primary transition-colors";

            const app = document.getElementById('app-container');
            app.innerHTML = '';

            if (route === 'home') renderHome(app);
            if (route === 'schedule') renderSchedule(app);
            if (route === 'profiles') renderProfiles(app);
        }

        // --- CUSTOM CONFIRM MODAL LOGIC ---
        function openConfirm(message, callback) {
            confirmCallback = callback;
            const content = `
                <div class="flex flex-col h-full justify-center p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-rose-50 mb-6">
                        <svg class="h-8 w-8 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </div>
                    <h3 class="text-xl leading-6 font-black text-slate-800 mb-3">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ø±ÙÛŒÙ‚ØŸ</h3>
                    <p class="text-sm text-slate-500 mb-8 leading-relaxed">${message}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="executeConfirm()" class="btn-press w-full rounded-2xl border border-transparent shadow-lg shadow-rose-100 px-4 py-3.5 bg-rose-500 text-base font-bold text-white hover:bg-rose-600 focus:outline-none">
                            Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
                        </button>
                        <button onclick="closeModal()" class="btn-press w-full rounded-2xl border border-slate-200 shadow-sm px-4 py-3.5 bg-white text-base font-bold text-slate-700 hover:bg-slate-50 focus:outline-none">
                            Ù†Ù‡ØŒ Ù…Ù†ØµØ±Ù Ø´Ø¯Ù…
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }

        function executeConfirm() {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            closeModal();
        }

        // --- RENDER VIEWS ---
        function renderHome(container) {
            const currentEvent = getCurrentEvent();
            container.innerHTML = `
                <div class="fade-in space-y-5">
                    <!-- Context Bar -->
                    <div class="bg-white border border-slate-100 rounded-gg p-5 flex items-center justify-between shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-full bg-gradient-to-l from-cyan-50/50 to-transparent"></div>
                        <div class="flex items-center gap-5 w-full relative z-10">
                             <div class="flex flex-col items-center justify-center min-w-[80px]">
                                <span class="text-3xl font-black text-primary font-[Vazirmatn] tracking-tight pt-1">${toPersianDigits(getCurrentTime())}</span>
                                <span class="text-[10px] text-cyan-600 font-bold mt-0.5 opacity-80">Ø¨Ù‡ ÙˆÙ‚Øª Ø¹Ø§Ø´Ù‚ÛŒ</span>
                             </div>
                             
                             <div class="w-px h-10 bg-slate-100"></div>
                             
                             <div class="flex flex-col flex-grow items-start overflow-hidden">
                                 <span class="text-[10px] text-slate-400 font-bold mb-1.5">Ù‡Ù…â€ŒØ§Ú©Ù†ÙˆÙ† Ø¯Ø± Ø³Ù†Ú¯Ø±:</span>
                                 <div class="flex items-center gap-2.5 w-full">
                                    <span class="flex-shrink-0 w-2.5 h-2.5 bg-primary rounded-full animate-pulse shadow-[0_0_10px_rgba(8,145,178,0.4)]"></span>
                                    <span class="text-sm font-bold text-slate-700 truncate w-full leading-tight">${currentEvent ? currentEvent.title : 'ÙØ±ØµØª Ø®Ù„ÙˆØª'}</span>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-6 rounded-gg shadow-sm border border-slate-100">
                        <label class="block text-slate-800 font-black mb-4 flex items-center gap-2.5">
                            <div class="bg-cyan-100 p-2 rounded-xl text-primary">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            </div>
                            Ø§ØªØ§Ù‚ ÙÚ©Ø± Ø¬Ù‡Ø§Ø¯ÛŒ
                        </label>
                        <p class="text-xs text-slate-500 mb-4 leading-relaxed bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            Ø³Ù„Ø§Ù… Ø®Ø§Ø¯Ù… Ø¹Ø²ÛŒØ²Ø› Ø¯ØºØ¯ØºÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø±Ø§Ù† Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† Ø¯Ø§Ø±ÛŒØŸ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ ØªØ§ Ø¨Ø§ Ù‡Ù… Ø­Ù„Ø´ Ú©Ù†ÛŒÙ…...
                        </p>
                        <textarea id="mentor-input" rows="3" class="w-full bg-white border border-slate-200 rounded-2xl p-4 text-slate-700 placeholder-slate-300 focus:ring-2 focus:ring-cyan-100 focus:border-primary transition-all resize-none text-sm leading-relaxed" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¨Ú†Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø±ÙØª Ú©Ù…ÛŒ Ø®Ø³ØªÙ‡ Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ù†Ø¯..."></textarea>
                        
                        <button onclick="generateProtocol()" class="btn-press mt-5 w-full bg-primary text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-primary-hover transition-all shadow-lg shadow-cyan-100">
                            <span id="btn-icon" class="text-lg">âœ¨</span>
                            <span id="btn-text">Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ Ùˆ Ø±Ø§Ù‡Ú©Ø§Ø±</span>
                            <div id="btn-loader" class="loader hidden"></div>
                        </button>
                    </div>

                    <!-- Output Area -->
                    <div id="result-area" class="hidden pb-24">
                        <div class="flex items-center gap-2.5 mb-5 px-3 mt-8">
                            <div class="h-6 w-1.5 bg-primary rounded-full"></div>
                            <h2 class="font-bold text-slate-800 text-lg">Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ Ùˆ Ø±Ø§Ù‡Ú©Ø§Ø± Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</h2>
                        </div>
                        <div id="ai-output" class="space-y-4"></div>
                    </div>
                </div>
            `;
        }

        function renderSchedule(container) {
            let html = `
                <div class="fade-in space-y-5">
                    <div class="flex justify-between items-center px-2 mb-2">
                        <div>
                            <h2 class="text-xl font-black text-slate-800">Ù†Ø¸Ù… Ùˆ Ø¬Ù‡Ø§Ø¯</h2>
                            <p class="text-xs text-slate-500 mt-1">Ø³ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</p>
                        </div>
                        <button onclick="addScheduleItem()" class="btn-press bg-primary text-white px-4 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-100 hover:bg-primary-hover transition-all flex items-center gap-1.5">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯
                        </button>
                    </div>

                    <div class="space-y-3 pb-24">
            `;

            state.schedule.sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            state.schedule.forEach((item, index) => {
                html += `
                    <div class="bg-white p-2.5 pl-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 transition-all hover:border-cyan-100">
                        <div class="relative min-w-[75px] text-center">
                            <span class="text-primary font-black text-lg font-[Vazirmatn] tracking-tight">${toPersianDigits(item.time)}</span>
                            <input type="time" value="${item.time}" 
                                onchange="updateSchedule(${index}, 'time', this.value)"
                                class="absolute inset-0 opacity-0 w-full h-full cursor-pointer z-10">
                        </div>
                        
                        <div class="flex-grow">
                            <input type="text" value="${item.title.replace(/"/g,'&quot;')}" 
                                onchange="updateSchedule(${index}, 'title', this.value)"
                                class="w-full font-bold text-slate-700 bg-transparent border-none focus:ring-0 p-0 placeholder-slate-300 text-sm" 
                                placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡">
                        </div>

                        <!-- Small Delete X -->
                        <button onclick="deleteSchedule(${index})" class="text-slate-300 hover:text-rose-400 p-2 rounded-full hover:bg-rose-50 transition-colors btn-press">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderProfiles(container) {
            let html = `
                <div class="fade-in space-y-5">
                    <div class="flex justify-between items-end px-2 mb-2">
                        <div>
                            <h2 class="text-xl font-black text-slate-800">Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§</h2>
                            <p class="text-xs text-slate-500 mt-1">Ø¯ÛŒØ¯Ù‡â€ŒØ¨Ø§Ù†ÛŒ Ø±Ø´Ø¯ ÛŒØ§Ø±Ø§Ù†</p>
                        </div>
                        <button onclick="openAddProfileModal()" class="btn-press bg-primary text-white px-4 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-100 hover:bg-primary-hover transition-colors flex items-center gap-1.5">
                            <span>+</span>
                            <span>Ø³Ø±Ø¨Ø§Ø² Ø¬Ø¯ÛŒØ¯</span>
                        </button>
                    </div>
                    <div class="space-y-6 pb-24">
            `;

            if (state.profiles.length === 0) {
                html += `<div class="text-center text-slate-400 py-16 flex flex-col items-center gap-3">
                    <span class="text-4xl opacity-20">ğŸŒ±</span>
                    <span class="text-sm">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒØ§ÛŒ ØªØ´Ú©ÛŒÙ„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>
                </div>`;
            }

            state.profiles.forEach((p, idx) => {
                const logs = p.logs || [];
                
                html += `
                    <div class="bg-white rounded-[1.75rem] shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50/60 p-5 flex justify-between items-center border-b border-slate-100">
                            <div class="flex items-center gap-3.5">
                                <div class="w-11 h-11 rounded-full bg-white border border-slate-200 flex items-center justify-center font-black text-primary shadow-sm text-lg">
                                    ${p.name[0] || ''}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800 text-base">${p.name}</div>
                                    <div class="text-[10px] text-slate-400 font-bold bg-white px-2 py-0.5 rounded-full inline-block border border-slate-100 mt-0.5">${toPersianDigits(String(p.age))} Ø³Ø§Ù„Ù‡</div>
                                </div>
                            </div>
                            <!-- Small Delete X -->
                            <button onclick="deleteProfile(${idx})" class="p-2 text-slate-300 hover:text-rose-400 transition-colors btn-press">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <div class="p-5 bg-white">
                             <div class="timeline-container">
                                <div class="timeline-line"></div>
                                <div class="space-y-7">
                                    ${logs.map((log, logIdx) => {
                                        const isAi = log.type === 'ai';
                                        return `
                                        <div class="timeline-item group">
                                            <div class="timeline-dot ${isAi ? 'ai' : 'user'}"></div>
                                            <div class="flex justify-between items-center mb-2 pl-1">
                                                <div class="relative group/time bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">
                                                    <span class="text-[10px] font-bold ${isAi ? 'text-amber-600' : 'text-primary'}">
                                                        ${toPersianDigits(log.time)}
                                                    </span>
                                                    <input type="time" value="${log.time}" 
                                                        onchange="updateLog(${idx}, ${logIdx}, 'time', this.value)"
                                                        class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                                                </div>
                                                
                                                <div class="flex items-center gap-1.5">
                                                    ${isAi ? '<span class="text-[9px] bg-amber-50 text-amber-600 px-2 py-0.5 rounded-md font-bold border border-amber-100">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</span>' : ''}
                                                    <!-- Small Delete X -->
                                                    <button onclick="deleteLog(${idx}, ${logIdx})" class="text-slate-300 hover:text-rose-400 transition-colors p-1.5 btn-press">
                                                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                                    </button>
                                                </div>
                                            </div>

                                            <textarea 
                                                onchange="updateLog(${idx}, ${logIdx}, 'note', this.value)"
                                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                                class="w-full text-sm leading-7 ${isAi ? 'bg-amber-50 border-amber-100 text-amber-900' : 'bg-slate-50 border-slate-100 text-slate-600'} p-3.5 rounded-2xl rounded-tr-sm border shadow-sm focus:bg-white focus:ring-1 focus:ring-cyan-200 focus:text-slate-800 transition-all resize-none overflow-hidden placeholder-slate-300 min-h-[56px] focus:outline-none"
                                                >${log.note.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-5 border-t border-dashed border-slate-200 flex gap-2.5">
                                <input type="text" id="log-input-${idx}" 
                                    class="flex-grow bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-cyan-100 focus:bg-white focus:border-primary transition-all"
                                    placeholder="Ø«Ø¨Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯..."
                                    onkeydown="if(event.key === 'Enter') addLog(${idx})">
                                <button onclick="addLog(${idx})" class="btn-press bg-primary text-white w-12 rounded-2xl flex items-center justify-center hover:bg-primary-hover shadow-lg shadow-cyan-100 transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
                                </button>
                            </div>

                            <button onclick="analyzeProfile(${idx})" id="analyze-btn-${idx}" class="btn-press mt-3 w-full bg-orange-500 text-white py-3.5 rounded-2xl text-xs font-bold hover:bg-orange-600 shadow-lg shadow-orange-100 transition-all flex items-center justify-center gap-2 group">
                                <svg class="w-4 h-4 text-white group-hover:rotate-12 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                <span>ØªØ­Ù„ÛŒÙ„ Ø®Ø§Ø¯Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
        }

        // --- CORE LOGIC ---
        async function generateProtocol() {
            // Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù† ØªØ§ fetch Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯
            if (fetchPromptsPromise) {
                await fetchPromptsPromise;
            }
            
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ state Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª (Ø§Ø² localStorage Ø¨Ø®ÙˆØ§Ù†)
            const savedPrompts = JSON.parse(localStorage.getItem('prompts'));
            if (savedPrompts) {
                state.prompts = savedPrompts;
            }
            
            const inputEl = document.getElementById('mentor-input');
            const input = inputEl ? inputEl.value : '';
            if (!input.trim()) return showToast('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¯ØºØ¯ØºÙ‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯');

            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const outputArea = document.getElementById('result-area');
            const aiOutput = document.getElementById('ai-output');

            if (btnText) btnText.classList.add('hidden');
            if (btnLoader) btnLoader.classList.remove('hidden');
            if (outputArea) outputArea.classList.add('hidden');

            try {
                const timeNow = getCurrentTime();
                const currentEvent = getCurrentEvent();
                const safeProfiles = state.profiles.map(p => ({ name: p.name, age: p.age, recent_log: (p.logs && p.logs.length) ? p.logs[p.logs.length-1]?.note : "Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª" }));

                const userPrompt = `
                    Current Context:
                    - Time: ${timeNow}
                    - Current Event: ${currentEvent ? currentEvent.title : 'Free Time'}
                    - User (Mentor) Input: "${input}"
                    - Students: ${JSON.stringify(safeProfiles)}
                `;

                const rawText = await callGemini(userPrompt, state.prompts.mentorProtocol);

                let result;
                try {
                    let clean = String(rawText).replace(/```json\n?|```/g, '').trim();
                    result = typeof clean === 'string' ? JSON.parse(clean) : clean;
                } catch (e) {
                    result = { diagnosis: "Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ", action: String(rawText), ammo: "...", targeting: "..." };
                }

                const html = `
                    <div class="protocol-card border-amber-500">
                        <div class="bg-amber-50 p-4 font-bold text-amber-800 text-sm flex items-center gap-2.5 border-b border-amber-100">
                            <span class="text-xl">ğŸ©º</span> ØªØ´Ø®ÛŒØµ Ùˆ Ø±ÛŒØ´Ù‡â€ŒÛŒØ§Ø¨ÛŒ
                        </div>
                        <div class="p-5 text-sm leading-8 text-slate-700 bg-white">${escapeHtml(String(result.diagnosis || 'â€”'))}</div>
                    </div>
                    <div class="protocol-card border-emerald-500">
                        <div class="bg-emerald-50 p-4 font-bold text-emerald-800 text-sm flex items-center gap-2.5 border-b border-emerald-100">
                            <span class="text-xl">âš¡</span> Ø§Ù‚Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø¯ÛŒ ÙÙˆØ±ÛŒ
                        </div>
                        <div class="p-5 text-sm leading-8 text-slate-700 bg-white">${escapeHtml(String(result.action || 'â€”'))}</div>
                    </div>
                    <div class="protocol-card border-cyan-500">
                        <div class="bg-cyan-50 p-4 font-bold text-cyan-800 text-sm flex items-center gap-2.5 border-b border-cyan-100">
                            <span class="text-xl">ğŸ’</span> Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ (Ø­Ø¯ÛŒØ«/Ù†Ú©ØªÙ‡)
                        </div>
                        <div class="p-5 text-sm leading-8 text-slate-700 bg-cyan-50/20 italic">"${escapeHtml(String(result.ammo || 'â€”'))}"</div>
                    </div>
                    <div class="protocol-card border-rose-500">
                        <div class="bg-rose-50 p-4 font-bold text-rose-800 text-sm flex items-center gap-2.5 border-b border-rose-100">
                            <span class="text-xl">ğŸ¯</span> ØªÙ‚Ø³ÛŒÙ… Ø³Ù†Ú¯Ø± (Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§)
                        </div>
                        <div class="p-5 text-sm leading-8 text-slate-700 bg-white">${escapeHtml(String(result.targeting || 'â€”'))}</div>
                    </div>
                `;

                if (aiOutput) aiOutput.innerHTML = html;
                if (outputArea) {
                    outputArea.classList.remove('hidden');
                    outputArea.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error(error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø®Ø§Ø¯Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯.');
            } finally {
                if (btnText) btnText.classList.remove('hidden');
                if (btnLoader) btnLoader.classList.add('hidden');
            }
        }

        async function analyzeProfile(index) {
            // Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù† ØªØ§ fetch Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯
            if (fetchPromptsPromise) {
                await fetchPromptsPromise;
            }
            
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ state Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª (Ø§Ø² localStorage Ø¨Ø®ÙˆØ§Ù†)
            const savedPrompts = JSON.parse(localStorage.getItem('prompts'));
            if (savedPrompts) {
                state.prompts = savedPrompts;
            }
            
            const btn = document.getElementById(`analyze-btn-${index}`);
            if (!btn) return showToast('Ø¯Ú©Ù…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
            const originalContent = btn.innerHTML;
            const profile = state.profiles[index];

            btn.disabled = true;
            btn.innerHTML = `<div class="loader w-4 h-4 border-white border-b-transparent"></div> <span>Ø¯Ø± Ø­Ø§Ù„ ØªÙÚ©Ø±...</span>`;

            try {
                const userPrompt = `
                    Profile Data:
                    Name: ${profile.name}
                    Age: ${profile.age}
                    Full Logs (Chronological): ${JSON.stringify(profile.logs)}
                `;

                const rawText = await callGemini(userPrompt, state.prompts.profileAnalysis);

                let result;
                try {
                     let clean = String(rawText).replace(/```json\n?|```/g, '').trim();
                     result = JSON.parse(clean);
                } catch (e) {
                    result = { sentiment: "ØªØ­Ù„ÛŒÙ„ Ù…ØªÙ†ÛŒ", advice: String(rawText) };
                }

                const newLog = {
                    time: getCurrentTime(),
                    note: `[${result.sentiment}]: ${result.advice}`,
                    type: 'ai'
                };

                state.profiles[index].logs.push(newLog);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø«Ø¨Øª Ø´Ø¯');

            } catch (error) {
                console.error(error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„.');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- CRUD ---
        function updateSchedule(index, field, value) {
            state.schedule[index][field] = value;
            if (field === 'time') {
                state.schedule.sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));
                saveData();
                renderSchedule(document.getElementById('app-container'));
            } else {
                saveData();
            }
        }

        function deleteSchedule(index) {
            openConfirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø² Ø³ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ', () => {
                state.schedule.splice(index, 1);
                saveData();
                renderSchedule(document.getElementById('app-container'));
                showToast('Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            });
        }

        function addScheduleItem() {
            state.schedule.push({ id: Date.now(), time: "00:00", title: "" });
            saveData();
            renderSchedule(document.getElementById('app-container'));
        }

        function updateLog(profileIndex, logIndex, field, value) {
            if (field === 'note' && !String(value).trim()) return;
            state.profiles[profileIndex].logs[logIndex][field] = value;
            saveData();
        }

        function deleteLog(profileIndex, logIndex) {
            openConfirm('Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø«Ø¨Øª Ø§Ø² Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ', () => {
                state.profiles[profileIndex].logs.splice(logIndex, 1);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('Ø«Ø¨Øª Ø­Ø°Ù Ø´Ø¯');
            });
        }

        function addLog(index) {
            const input = document.getElementById(`log-input-${index}`);
            const val = input ? input.value.trim() : '';
            if(!val) return;

            state.profiles[index].logs.push({
                time: getCurrentTime(),
                note: val,
                type: 'user'
            });
            saveData();
            if (input) input.value = '';
            renderProfiles(document.getElementById('app-container'));
        }

        function deleteProfile(index) {
            openConfirm('Ø¢ÛŒØ§ Ú©Ù„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø§ÛŒÙ† Ø³Ø±Ø¨Ø§Ø² Ø­Ø°Ù Ø´ÙˆØ¯ØŸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.', () => {
                state.profiles.splice(index, 1);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ (Ø­Ø°Ù) Ø´Ø¯');
            });
        }

        function resetFactory() {
            openConfirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.', () => {
                localStorage.clear();
                location.reload();
            });
        }

        // --- SETTINGS & MODALS ---
        async function openSettingsModal() {
            // Ø§Ú¯Ø± fetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³ØªØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†
            if (fetchPromptsPromise) {
                await fetchPromptsPromise;
            }
            
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ state Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª (Ø§Ø² localStorage Ø¨Ø®ÙˆØ§Ù†)
            const savedPrompts = JSON.parse(localStorage.getItem('prompts'));
            if (savedPrompts) {
                state.prompts = savedPrompts;
            }
            
            const modalContent = `
                <div class="h-full overflow-y-auto bg-white custom-scrollbar">
                    <div class="p-5 pb-4 border-b border-slate-100 sticky top-0 bg-white/95 backdrop-blur-sm z-10">
                        <h3 class="font-black text-xl text-slate-800">Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ø®Ø§Ø¯Ù…</h3>
                        <p class="text-xs text-slate-400 mt-1">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ùˆ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§</p>
                    </div>

                    <div class="p-5 space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2 flex items-center gap-1.5">
                                <span class="text-lg">âš¡</span> Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø§ØªØ§Ù‚ ÙÚ©Ø± (Protocol Prompt)
                            </label>
                            <textarea id="set-prompt-main" readonly class="w-full text-xs p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:border-primary focus:bg-white focus:outline-none font-mono leading-relaxed shadow-inner text-slate-600 cursor-not-allowed" rows="6">${escapeHtml(state.prompts.mentorProtocol || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2 flex items-center gap-1.5">
                                <span class="text-lg">ğŸ§ </span> Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ ØªØ­Ù„ÛŒÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ (System Prompt)
                            </label>
                            <textarea id="set-prompt-profile" readonly class="w-full text-xs p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:border-primary focus:bg-white focus:outline-none font-mono leading-relaxed shadow-inner text-slate-600 cursor-not-allowed" rows="6">${escapeHtml(state.prompts.profileAnalysis || '')}</textarea>
                        </div>

                         <!-- Educational Link Section -->
                        <a href="darsname_etekaf/etekaf_darsname_simple.html" target="_blank" class="block group">
                            <div class="bg-gradient-to-br from-rose-50 to-white border border-rose-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                                <div class="flex items-center gap-4">
                                    <div class="bg-rose-100 p-3 rounded-2xl text-rose-600 group-hover:bg-rose-600 group-hover:text-white transition-colors">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-sm group-hover:text-rose-700 transition-colors">Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ Ø¬Ø§Ù…Ø¹ Ù…Ø±Ø¨ÛŒØ§Ù†</h4>
                                        <p class="text-[10px] text-slate-500 mt-1">Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø³Ù†Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ Ø§ØµÙˆÙ„ ØªØ±Ø¨ÛŒØªÛŒ Ø§Ø¹ØªÚ©Ø§Ù</p>
                                    </div>
                                    <div class="mr-auto text-rose-300 group-hover:text-rose-500">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ†ÛŒ -->
                        <a href="https://taavonafarin.ir" target="_blank" class="block group">
                            <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                                <div class="flex items-center gap-4">
                                    <div class="bg-blue-100 p-3 rounded-2xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors relative">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                        <span class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></span>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition-colors">Ù…Ø¹Ø±ÙÛŒ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ†ÛŒ</h4>
                                        <p class="text-[10px] text-slate-500 mt-1">ÙˆØ¨Ø³Ø§ÛŒØª Ú¯Ø±ÙˆÙ‡ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ†</p>
                                    </div>
                                    <div class="mr-auto text-blue-300 group-hover:text-blue-500">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- Ú¯Ø±ÙˆÙ‡ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ† Ø¯Ø± Ø§ÛŒØªØ§ -->
                        <a href="https://eitaa.com/taavonafarin" target="_blank" class="block group">
                            <div class="bg-gradient-to-br from-orange-50 to-white border border-orange-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                                <div class="flex items-center gap-4">
                                    <div class="bg-orange-100 p-3 rounded-2xl text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-sm group-hover:text-orange-700 transition-colors">Ú¯Ø±ÙˆÙ‡ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ† Ø¯Ø± Ø§ÛŒØªØ§</h4>
                                        <p class="text-[10px] text-slate-500 mt-1">Ø¨Ø§ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú¯Ø±ÙˆÙ‡ØŒ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ø±ÙˆØ² Ø¨Ù…Ø§Ù†ÛŒØ¯</p>
                                    </div>
                                    <div class="mr-auto text-orange-300 group-hover:text-orange-500">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <!-- Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ùˆ Ù†Ø¸Ø±Ø§Øª -->
                        <a href="https://eitaa.com/yoosof_e_zahra" target="_blank" class="block group">
                            <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                                <div class="flex items-center gap-4">
                                    <div class="bg-purple-100 p-3 rounded-2xl text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-sm group-hover:text-purple-700 transition-colors">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ùˆ Ù†Ø¸Ø±Ø§Øª</h4>
                                        <p class="text-[10px] text-slate-500 mt-1">Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ù…Ø§ Ø¨Ø±Ø³Ø§Ù†ÛŒØ¯</p>
                                    </div>
                                    <div class="mr-auto text-purple-300 group-hover:text-purple-500">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                    </div>
                                </div>
                            </div>
                        </a>
                        
                        <div class="pt-2 space-y-3">
                            <button onclick="refreshPrompts()" class="btn-press w-full bg-blue-500 text-white py-3.5 rounded-2xl font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                                <span>Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet</span>
                            </button>
                            <button onclick="saveSettings()" class="btn-press w-full bg-primary text-white py-3.5 rounded-2xl font-bold hover:bg-primary-hover transition-colors shadow-lg shadow-cyan-100">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                            <button onclick="closeModal()" class="btn-press w-full text-slate-400 py-2 text-sm font-bold hover:text-slate-600">Ø§Ù†ØµØ±Ø§Ù</button>
                            <div class="pt-2 flex justify-center">
                                <button onclick="resetFactory()" class="text-[10px] text-rose-300 hover:text-rose-500 transition-colors">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</button>
                            </div>
                        </div>
                        <div class="h-6"></div>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        async function refreshPrompts() {
            showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§...');
            // fetch Ø¬Ø¯ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
            fetchPromptsPromise = fetchPromptsFromUrl();
            await fetchPromptsPromise;
            // modal Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
            openSettingsModal();
            showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
        }

        function saveSettings() {
            // Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÛŒØ³ØªÙ†Ø¯ Ùˆ Ø§Ø² URL Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
            // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯Ù‡
            closeModal();
            showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÛŒØ³ØªÙ†Ø¯');
        }

        function openAddProfileModal() {
            const modalContent = `
                <div class="h-full overflow-y-auto bg-white custom-scrollbar flex flex-col">
                    <div class="p-6 text-center">
                        <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-cyan-50 mb-6 text-2xl">
                            ğŸŒ±
                        </div>
                        <h3 class="text-xl leading-6 font-black text-slate-800 mb-2">Ø³Ø±Ø¨Ø§Ø² Ø¬Ø¯ÛŒØ¯</h3>
                        <p class="text-sm text-slate-400 mb-6">Ù…Ø´Ø®ØµØ§Øª ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
                        
                        <div class="space-y-4 mb-6 text-right">
                            <div>
                                <input id="new-profile-name" class="w-full p-4 rounded-2xl border border-slate-200 bg-slate-50 text-center font-bold text-slate-700 focus:bg-white focus:border-primary focus:outline-none transition-all" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
                            </div>
                            <div>
                                <input id="new-profile-age" type="number" min="1" class="w-full p-4 rounded-2xl border border-slate-200 bg-slate-50 text-center text-slate-700 focus:bg-white focus:border-primary focus:outline-none transition-all" placeholder="Ø³Ù† (Ø³Ø§Ù„)">
                            </div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="saveNewProfile()" class="btn-press w-full bg-slate-800 text-white py-3.5 rounded-2xl font-bold hover:bg-slate-900 transition-colors shadow-lg shadow-slate-200">Ø«Ø¨Øª Ù¾Ø±ÙˆÙ†Ø¯Ù‡</button>
                            <button onclick="closeModal()" class="btn-press w-full text-slate-400 py-2 text-sm font-bold hover:text-slate-600">Ø§Ù†ØµØ±Ø§Ù</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function saveNewProfile() {
            const nameEl = document.getElementById('new-profile-name');
            const ageEl = document.getElementById('new-profile-age');
            const name = nameEl ? nameEl.value.trim() : '';
            const age = ageEl ? parseInt(ageEl.value, 10) : NaN;
            if (!name) return showToast('Ù†Ø§Ù… Ø³Ø±Ø¨Ø§Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            if (!age || age <= 0) return showToast('Ø³Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

            state.profiles.push({ name, age, logs: [] });
            saveData();
            closeModal();
            renderProfiles(document.getElementById('app-container'));
            showToast('Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ ØªØ´Ú©ÛŒÙ„ Ø´Ø¯');
        }

        // --- UTILS ---
        function showModal(content) {
            const overlay = document.getElementById('modal-overlay');
            const card = document.getElementById('modal-card');
            card.innerHTML = content;
            overlay.classList.remove('hidden');
            setTimeout(() => { 
                card.classList.remove('scale-95', 'opacity-0'); 
                card.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const card = document.getElementById('modal-card');
            card.classList.remove('scale-100', 'opacity-100');
            card.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                card.innerHTML = ''; 
            }, 300);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'scale-90');
            t.style.pointerEvents = 'auto';
            setTimeout(() => { t.classList.add('opacity-0', 'scale-90'); t.style.pointerEvents = 'none'; }, 3000);
        }

        function getCurrentTime() {
            const d = new Date();
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            return `${hh}:${mm}`;
        }

        function getCurrentEvent() {
            const now = new Date();
            const nowMin = now.getHours() * 60 + now.getMinutes();
            let found = null;
            for (let i = 0; i < state.schedule.length; i++) {
                const itemMin = timeToMinutes(state.schedule[i].time);
                if (nowMin <= itemMin) { found = state.schedule[i]; break; }
            }
            return found || state.schedule[0] || { title: "ÙˆÙ‚Øª Ø¢Ø²Ø§Ø¯" };
        }

        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function windowExpose() {
            Object.assign(window, {
                router,
                generateProtocol,
                openSettingsModal,
                addScheduleItem,
                updateSchedule,
                deleteSchedule,
                openAddProfileModal,
                saveNewProfile,
                updateLog,
                deleteLog,
                addLog,
                deleteProfile,
                analyzeProfile,
                saveSettings,
                refreshPrompts,
                closeModal,
                resetFactory,
                executeConfirm
            });
        }

        // Init
        windowExpose();
        router('home');

    </script>
</body>
</html>