<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø§Ø¯Ù…Ø§Ù† Ø§Ø¹ØªÚ©Ø§Ù</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    <!-- ÙØ§ÛŒÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª API - Ø¨Ø§ÛŒØ¯ Ø§Ø² build-config.js ØªÙˆÙ„ÛŒØ¯ Ø´ÙˆØ¯ -->
    <script src="config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0891b2', // ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ Ø®Ø§Øµ (Cyan-600)
                        'primary-hover': '#0e7490',
                        'soft-bg': '#f0f9ff',
                    },
                    borderRadius: {
                        'gg': '1.5rem', // Googooli Radius
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            color: #334155;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .timeline-container { position: relative; padding-right: 24px; }
        .timeline-line { position: absolute; top: 16px; bottom: 0; right: 10px; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .timeline-item { position: relative; margin-bottom: 24px; }
        .timeline-dot { width: 12px; height: 12px; background: #fff; border: 3px solid #94a3b8; border-radius: 50%; position: absolute; right: -20px; top: 8px; z-index: 1; transition: all 0.2s; }
        .timeline-dot.ai { border-color: #f59e0b; background: #fef3c7; }
        .timeline-dot.user { border-color: #0891b2; background: #cffafe; }

        .protocol-card { border-right: 4px solid; background: #fff; margin-bottom: 1rem; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.03); overflow: hidden; }
        
        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        input[type="time"]::-webkit-calendar-picker-indicator { display: none; }
        .persian-num { font-feature-settings: "ss01"; }
        
        /* Micro-animation for clicks */
        .btn-press:active { transform: scale(0.92); transition: transform 0.1s; }
    </style>
</head>
<body class="bg-soft-bg min-h-screen selection:bg-cyan-100">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 border-b border-cyan-100">
        <div class="max-w-md mx-auto px-5 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-primary text-white p-2.5 rounded-2xl shadow-lg shadow-cyan-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </div>
                <div>
                    <h1 class="font-black text-slate-700 text-lg tracking-tight">ÛŒØ§ÙˆØ± Ù…Ø±Ø¨ÛŒ</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-[11px] text-slate-400 font-bold">Ø§Ø¹ØªÚ©Ø§Ù ÛŒØ§Ø±Ø§Ù† Ù…ÙˆØ¹ÙˆØ¯</span>
                    </div>
                </div>
            </div>
            <button onclick="openSettingsModal()" class="btn-press p-3 text-slate-400 hover:text-primary transition-colors rounded-full hover:bg-cyan-50" title="Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ø®Ø§Ø¯Ù…">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <main id="app-container" class="max-w-md mx-auto w-full p-5 relative min-h-[calc(100vh-140px)]"></main>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.05)] z-40 rounded-t-3xl">
        <div class="max-w-md mx-auto grid grid-cols-3 h-20 items-center pb-2">
            <button onclick="router('home')" id="nav-home" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-800">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ø³Ù†Ú¯Ø± ÙØ±Ù‡Ù†Ú¯ÛŒ</span>
            </button>
            <button onclick="router('schedule')" id="nav-schedule" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ù†Ø¸Ù… Ùˆ Ø¬Ù‡Ø§Ø¯</span>
            </button>
            <button onclick="router('profiles')" id="nav-profiles" class="nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400">
                <div class="p-1 rounded-xl transition-colors">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <span class="text-[11px] font-bold">Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§</span>
            </button>
        </div>
    </nav>

    <!-- General Modal (Click outside to close) -->
    <div id="modal-overlay" onclick="if(event.target === this) closeModal()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] z-50 hidden flex items-center justify-center transition-all duration-300 px-4 pb-4 sm:pb-0">
        <div id="modal-card" class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl transform scale-95 opacity-0 transition-all duration-300 h-[85vh] max-h-[85vh] flex flex-col relative overflow-hidden">
            <!-- Modal content -->
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur-md text-white px-6 py-3.5 rounded-2xl shadow-xl text-sm font-medium z-[60] flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 scale-90 border border-slate-700/50">
        <span class="text-xl">ğŸ•Šï¸</span>
        <span id="toast-msg">Ù¾ÛŒØ§Ù… Ø³ÛŒØ³ØªÙ…</span>
    </div>

    <script>
        // --- CONFIG ---
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„ config.js Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        const config = window.APP_CONFIG || {
            apiKey: "",
            baseUrl: "https://selfclaude.flearning.ir/",
            apiEndpoint: "v1/chat/completions",
            promptsUrl: "https://opensheet.elk.sh/1yxTX1rxNpJ_HDDLxpgi4CmqIJ3S3uZgII9phrjUl_uY/Sheet1" // URL Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet
        };
        
        const apiKey = config.apiKey;
        const baseUrl = config.baseUrl;
        const apiEndpoint = config.apiEndpoint;

        // --- SAFE API CALLER ---
        // NOTE: Ù…Ù†Ø·Ù‚ Ø³Ø§Ø®Øª Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ (userPrompt) Ù†Ø¨Ø§ÛŒØ¯ Ø¯Ø³ØªÚ©Ø§Ø±ÛŒ Ø´ÙˆØ¯.
        // ÙÙ‚Ø· Ú†Ø§Ø±Ú†ÙˆØ¨ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ API Ø¯Ø± Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        async function callGemini(userPrompt, systemInstruction) {
            console.log("ğŸ”µ [AI Request] Starting API call...");
            log('info', 'AI Request', 'Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ', {
                promptLength: userPrompt.length,
                systemLength: systemInstruction.length
            });
            console.log("ğŸ“ API Key configured:", !!apiKey);
            console.log("ğŸ“ Base URL:", baseUrl);
            console.log("ğŸ“ API Endpoint:", apiEndpoint);
            
            if (!apiKey) {
                console.warn("âš ï¸ [AI Request] API key not configured - using dummy response");
                log('warn', 'AI Request', 'API Key ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø§Ø³Ø® ØªØ³ØªÛŒ');
                await new Promise(r => setTimeout(r, 600));
                // Ù¾Ø§Ø³Ø® ØªØ³ØªÛŒ Ø¨Ù‡ ÙØ±Ù…Øª JSON Ú©Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±Ø¯
                const dummyResponse = JSON.stringify({
                    sections: [
                        { title: "âš ï¸ Ø­Ø§Ù„Øª ØªÙ…Ø±ÛŒÙ†ÛŒ", content: "Ù„Ø·ÙØ§Ù‹ API Key Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ config.js ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯." },
                        { title: "Ú¯Ø§Ù… Ø¨Ø¹Ø¯ÛŒ", content: "Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ†Ø¸ÛŒÙ… API KeyØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Â«Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯." },
                        { title: "ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ", content: "Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ JSON Ø¨Ø§Ø´Ø¯ Ùˆ ÙÙ‚Ø· Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ." }
                    ],
                    sentiment: "ØªØ³Øª",
                    advice: "Ø§ÛŒÙ† ÛŒÚ© Ù¾Ø§Ø³Ø® ØªØ³ØªÛŒ Ø§Ø³Øª. API Key Ø±Ø§ Ø¯Ø± config.js Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯"
                });
                log('info', 'AI Request', 'Ù¾Ø§Ø³Ø® ØªØ³ØªÛŒ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯', { 
                    note: 'Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ API Key ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯',
                    response: dummyResponse.substring(0, 150) + '...'
                });
                return dummyResponse;
            }

            // Ø³Ø§Ø®Øª URL Ú©Ø§Ù…Ù„ Ø¨Ø§ API Key Ø¯Ø± query string (Chat Completions API)
            const cleanBaseUrl = `${baseUrl}${apiEndpoint}`.replace(/\/+/g, '/').replace(/^https?:\//, 'https://');
            const url = `${cleanBaseUrl}?key=${apiKey}`;
            console.log("ğŸŒ [AI Request] Full URL:", cleanBaseUrl + '?key=***' + apiKey.slice(-4));
            log('info', 'AI Request', 'URL Ø¯Ø±Ø®ÙˆØ§Ø³Øª (Chat Completions)', { 
                url: cleanBaseUrl,
                apiKeyLast4: apiKey.slice(-4)
            });
            
            // ÙØ±Ù…Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø§ÛŒ Chat Completions API
            // Ù†Ú©ØªÙ‡: Ù‡ÛŒÚ† Ù…ØªÙ† Ø§Ø¶Ø§ÙÙ‡â€ŒØ§ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù‡ systemInstruction Ú†Ø³Ø¨Ø§Ù†Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            // Â«Ù‚ÙˆØ§Ø¹Ø¯ Ø²Ø¨Ø§Ù†/Ø®Ø±ÙˆØ¬ÛŒÂ» Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¯Ø§Ø®Ù„ System Instruction (Ø§Ø² Google Sheet) Ø¨Ø§Ø´Ø¯.
            const payload = {
                model: "gemini-2.5-flash",
                messages: [
                    {
                        role: "system",
                        content: `${systemInstruction}`
                    },
                    { role: "user", content: userPrompt }
                ]
            };
            console.log("ğŸ“¦ [AI Request] Payload (Chat Completions):", JSON.stringify(payload).substring(0, 200) + "...");
            log('info', 'AI Request', 'Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ AI', {
                format: 'Chat Completions API',
                model: payload.model,
                userPromptLength: userPrompt.length,
                systemPromptLength: systemInstruction.length
            });

            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    console.log(`ğŸ”„ [AI Request] Attempt ${i + 1}/${delays.length + 1}`);
                    log('info', 'AI Request', `ØªÙ„Ø§Ø´ ${i + 1} Ø§Ø² ${delays.length + 1} Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„`);
                    
                    const headers = { 
                        'Content-Type': 'application/json'
                        // Ø§ÛŒÙ† API Ø§Ø² API key Ø¯Ø± URL query string Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    };
                    
                    console.log("ğŸ“¨ [AI Request] Headers:", headers);
                    log('info', 'AI Request', 'Headers Ø¯Ø±Ø®ÙˆØ§Ø³Øª', {
                        hasContentType: !!headers['Content-Type'],
                        note: 'API key Ø¯Ø± URL query string Ø§Ø³Øª (format: ?key=API_KEY)'
                    });
                    
                    const bodyString = JSON.stringify(payload);
                    console.log("ğŸ“¤ [AI Request] Body size:", bodyString.length, "characters");
                    log('info', 'AI Request', 'Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª', {
                        bodySize: bodyString.length,
                        bodyPreview: bodyString.substring(0, 300) + '...'
                    });
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: bodyString
                    });
                    
                    console.log("ğŸ“¡ [AI Response] Status:", response.status, response.statusText);
                    log('info', 'AI Response', `ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®: ${response.status}`, { 
                        status: response.status,
                        statusText: response.statusText
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('âŒ [AI Response] API Error:', response.status, errorText);
                        log('error', 'AI Response', `Ø®Ø·Ø§ÛŒ API: ${response.status}`, { 
                            status: response.status,
                            errorText: errorText.substring(0, 500)
                        });
                        throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log("ğŸ“¥ [AI Response] Data received:", JSON.stringify(data).substring(0, 300) + "...");
                    log('info', 'AI Response', 'Ø¯Ø§Ø¯Ù‡ JSON Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', {
                        dataPreview: JSON.stringify(data).substring(0, 200) + '...',
                        hasChoices: !!data.choices,
                        choicesCount: data.choices?.length,
                        hasError: !!data.error
                    });
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§
                    if (data.error) {
                        console.error("âŒ [AI Response] API Error:", data.error);
                        log('error', 'AI Response', 'Ø®Ø·Ø§ÛŒ API', {
                            errorMessage: data.error.message || JSON.stringify(data.error),
                            errorCode: data.error.code,
                            errorType: data.error.type
                        });
                        throw new Error(data.error.message || JSON.stringify(data.error));
                    }
                    
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾Ø§Ø³Ø® Ø§Ø² ÙØ±Ù…Øª Chat Completions
                    let responseText = null;
                    
                    // Chat Completions: data.choices[0].message.content
                    if (data.choices && data.choices[0]?.message?.content) {
                        responseText = data.choices[0].message.content;
                        console.log("âœ… [AI Response] Extracted from chat.completions format");
                        log('success', 'AI Response', 'Ù¾Ø§Ø³Ø® Ø§Ø² ÙØ±Ù…Øª chat.completions Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯', {
                            finishReason: data.choices[0].finish_reason,
                            model: data.model,
                            usage: data.usage
                        });
                    }
                    // ÙØ±Ù…Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†: choices[0].text
                    else if (data.choices && data.choices[0]?.text) {
                        responseText = data.choices[0].text;
                        console.log("âœ… [AI Response] Extracted from completions format");
                        log('success', 'AI Response', 'Ù¾Ø§Ø³Ø® Ø§Ø² ÙØ±Ù…Øª Completions Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯');
                    }
                    // ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
                    else if (data.content) {
                        responseText = data.content;
                    }
                    else if (data.text) {
                        responseText = data.text;
                    }
                    else {
                        console.warn("âš ï¸ [AI Response] Unknown format, using JSON string");
                        log('warn', 'AI Response', 'ÙØ±Ù…Øª Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² JSON string', {
                            dataKeys: Object.keys(data),
                            fullData: JSON.stringify(data).substring(0, 500)
                        });
                        responseText = JSON.stringify(data);
                    }
                    
                    console.log("âœ… [AI Response] Extracted text:", responseText.substring(0, 200) + "...");
                    log('success', 'AI Response', 'Ù¾Ø§Ø³Ø® Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯', {
                        responsePreview: responseText.substring(0, 200) + '...',
                        responseLength: responseText.length
                    });
                    return responseText;
                } catch (error) {
                    console.error(`âŒ [AI Request] Attempt ${i + 1} failed:`, error);
                    log('error', 'AI Request', `ØªÙ„Ø§Ø´ ${i + 1} Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯`, {
                        error: error.message,
                        errorName: error.name,
                        stack: error.stack?.substring(0, 300)
                    });
                    
                    if (i === delays.length) {
                        console.error("âŒ [AI Request] All attempts failed. Final error:", error);
                        log('error', 'AI Request', 'ØªÙ…Ø§Ù… ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù†Ø¯', { 
                            finalError: error.message,
                            totalAttempts: delays.length + 1
                        });
                        throw error;
                    }
                    console.log(`â³ [AI Request] Waiting ${delays[i]}ms before retry...`);
                    log('info', 'AI Request', `Ø§Ù†ØªØ¸Ø§Ø± ${delays[i]}ms Ù‚Ø¨Ù„ Ø§Ø² ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯`);
                    await new Promise(r => setTimeout(r, delays[i]));
                }
            }
        }

        // --- DEFAULT DATA ---
        const DEFAULT_PROMPTS = {
            mentorProtocol: `Ø´Ù…Ø§ "Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø®Ø§Ø¯Ù…Ø§Ù† Ø§Ø¹ØªÚ©Ø§Ù" Ù‡Ø³ØªÛŒØ¯. Ø§Ø¯Ø¨ÛŒØ§Øª Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¨Ø³ÛŒØ§Ø± ØµÙ…ÛŒÙ…ÛŒØŒ Ø¬Ù‡Ø§Ø¯ÛŒ Ùˆ Ù…Ø¹Ù†ÙˆÛŒ Ø¨Ø§Ø´Ø¯.
Ø®Ø±ÙˆØ¬ÛŒ Ø´Ù…Ø§ Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ ÛŒÚ© JSON Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯ Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø± Ø²ÛŒØ±:
{
  "sections": [
    { "title": "ØªÛŒØªØ± Ú©ÙˆØªØ§Ù‡ Ùˆ Ù…ØªÙ†Ø§Ø³Ø¨", "content": "Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ" }
  ]
}
Ù‚ÙˆØ§Ù†ÛŒÙ†:
- ØªØ¹Ø¯Ø§Ø¯ sections Ø¨ÛŒÙ† 3 ØªØ§ 6 Ø¨Ø§Ø´Ø¯ (Ú©Ù…ØªØ±/Ø¨ÛŒØ´ØªØ± Ù…Ù…Ù†ÙˆØ¹).
- title Ùˆ content Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø¯ØºØ¯ØºÙ‡â€ŒÛŒ Ù…Ø±Ø¨ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (ØªÛŒØªØ±Ù‡Ø§ Ø«Ø§Ø¨Øª Ù†Ø¨Ø§Ø´Ù†Ø¯).
- content Ù‡Ø± Ø¨Ø®Ø´ ÙˆØ§Ø¶Ø­ØŒ Ø§Ø¬Ø±Ø§ÛŒÛŒ Ùˆ ÙØ§Ø±Ø³ÛŒÙ Ø±ÙˆØ§Ù† Ø¨Ø§Ø´Ø¯.
- ÙÙ‚Ø· JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø› Ø¨Ø¯ÙˆÙ† MarkdownØŒ Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­ Ø§Ø¶Ø§ÙÙ‡ØŒ Ø¨Ø¯ÙˆÙ† Ù…ØªÙ† Ø¨ÛŒØ±ÙˆÙ† Ø§Ø² JSON.
`,
            profileAnalysis: `Ø´Ù…Ø§ "Ù…Ø´Ø§ÙˆØ± ØªØ±Ø¨ÛŒØªÛŒ" Ø¯Ø± ÙØ¶Ø§ÛŒ Ø§Ø¹ØªÚ©Ø§Ù Ù‡Ø³ØªÛŒØ¯. Ù„Ø­Ù† Ø¯Ù„Ø³ÙˆØ²Ø§Ù†Ù‡ Ùˆ Ù…Ø±Ø¨ÛŒâ€ŒÚ¯ÙˆÙ†Ù‡. Ø®Ø±ÙˆØ¬ÛŒ JSON Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ sentiment Ùˆ advice.
ÙÙ‚Ø· JSON Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† Markdown.`
        };

        const DEFAULT_SCHEDULE = [
            { id: 1, time: "03:30", title: "Ù…Ù†Ø§Ø¬Ø§Øª Ø¨Ø§ Ù‚Ø§Ø¶ÛŒâ€ŒØ§Ù„Ø­Ø§Ø¬Ø§Øª (Ø³Ø­Ø±)" },
            { id: 2, time: "04:15", title: "Ø±Ø²Ù‚ Ø³Ø­Ø±ÛŒ" },
            { id: 3, time: "05:25", title: "Ù†Ù…Ø§Ø² ØµØ¨Ø­ (Ø¬Ù…Ø§Ø¹Øª)" },
            { id: 4, time: "06:00", title: "Ø¹Ù‡Ø¯ Ø¨Ø§ Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† (Ø¹Ø¬)" },
            { id: 5, time: "10:30", title: "Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø±ÙØª: Ø±ÙØ§Ù‚Øª Ø¨Ø§ Ø®Ø¯Ø§" },
            { id: 6, time: "12:15", title: "Ù†Ù…Ø§Ø² Ø¬Ù…Ø§Ø¹Øª Ø¸Ù‡Ø± Ùˆ Ø¹ØµØ±" },
            { id: 7, time: "13:30", title: "Ø®ÙˆØ§Ø¨ Ù‚ÛŒÙ„ÙˆÙ„Ù‡ (ØªØ¬Ø¯ÛŒØ¯ Ù‚ÙˆØ§)" },
            { id: 8, time: "16:00", title: "Ú¯Ø¹Ø¯Ù‡ ØµÙ…ÛŒÙ…Ø§Ù†Ù‡ Ø¹ØµØ±" },
            { id: 9, time: "17:30", title: "Ø®Ù„ÙˆØª Ø¨Ø§ Ù‚Ø±Ø¢Ù†" },
            { id: 10, time: "18:20", title: "Ù†Ù…Ø§Ø² Ù…ØºØ±Ø¨ Ùˆ Ø¹Ø´Ø§Ø¡" },
            { id: 11, time: "19:00", title: "Ø³ÙØ±Ù‡ Ø§ÙØ·Ø§Ø±" },
            { id: 12, time: "21:00", title: "Ù‡ÛŒØ¦Øª Ùˆ ØªÙˆØ³Ù„" },
            { id: 13, time: "23:00", title: "Ø®Ø§Ù…ÙˆØ´ÛŒ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª" }
        ];

        const DEFAULT_PROFILES = [
            {
                name: "Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ†", age: 14,
                logs: [
                    { time: "04:30", note: "Ø¯Ø± Ø­Ø§Ù„ Ú¯Ø±ÛŒÙ‡ Ùˆ ØªÙˆØ³Ù„ Ø¨ÙˆØ¯ØŒ Ø­Ø§Ù„ Ù…Ø¹Ù†ÙˆÛŒ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´Øª.", type: 'user' },
                    { time: "11:00", note: "Ú©Ù…ÛŒ Ú©Ø³Ù„ Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ø´Ø±Ú©Øª Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.", type: 'user' }
                ]
            }
        ];

        // --- STATE ---
        // Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:
        // - Â«Ø§ÛŒÙ†Ø³ØªØ±Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø² Google Sheet Ø¨ÛŒØ§ÛŒÙ†Ø¯Â».
        // - Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú¯ÛŒØ± Ú©Ø±Ø¯Ù† Ø±ÙˆÛŒ Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒÙ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¯Ø± localStorage,
        //   ÙÙ‚Ø· Ø²Ù…Ø§Ù†ÛŒ Ø§Ø² cache Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¨Ø§ Ù…ØªØ§Ø¯ÛŒØªØ§ÛŒ Ù…Ø¹ØªØ¨Ø± (Ù…Ù†Ø¨Ø¹: Sheet) Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.
        const PROMPTS_SCHEMA_VERSION = 2;

        function loadCachedSheetPrompts() {
            try {
                const metaRaw = localStorage.getItem('prompts_meta');
                const promptsRaw = localStorage.getItem('prompts');
                if (!metaRaw || !promptsRaw) return null;
                const meta = JSON.parse(metaRaw);
                if (meta?.source !== 'google_sheet') return null;
                if (meta?.schemaVersion !== PROMPTS_SCHEMA_VERSION) return null;
                const prompts = JSON.parse(promptsRaw);
                if (!prompts?.mentorProtocol || !prompts?.profileAnalysis) return null;
                return { prompts, meta };
            } catch {
                return null;
            }
        }

        const cached = loadCachedSheetPrompts();

        let state = {
            prompts: cached?.prompts || DEFAULT_PROMPTS,
            promptsLoaded: !!cached, // Ø§Ú¯Ø± cache Ù…Ø¹ØªØ¨Ø± Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            schedule: JSON.parse(localStorage.getItem('schedule')) || DEFAULT_SCHEDULE,
            profiles: JSON.parse(localStorage.getItem('profiles')) || DEFAULT_PROFILES
        };
        let confirmCallback = null;
        
        // --- LOGGING SYSTEM ---
        let appLogs = [];
        const MAX_LOGS = 500; // Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§
        
        function log(level, category, message, data = null) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = {
                time: timestamp,
                level: level, // info, warn, error, success
                category: category, // AI Request, Google Sheet, Generate Protocol, etc.
                message: message,
                data: data
            };
            
            appLogs.unshift(logEntry); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§ÙˆÙ„ Ø¢Ø±Ø§ÛŒÙ‡
            if (appLogs.length > MAX_LOGS) {
                appLogs.pop(); // Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ† Ù„Ø§Ú¯
            }
            
            // Ù„Ø§Ú¯ Ø¯Ø± console Ù‡Ù…
            const emoji = {
                'info': 'ğŸ”µ',
                'warn': 'âš ï¸',
                'error': 'âŒ',
                'success': 'âœ…'
            }[level] || 'â„¹ï¸';
            
            const consoleMsg = `${emoji} [${category}] ${message}`;
            
            if (level === 'error') {
                console.error(consoleMsg, data || '');
            } else if (level === 'warn') {
                console.warn(consoleMsg, data || '');
            } else {
                console.log(consoleMsg, data || '');
            }
        }
        
        function clearLogs() {
            if (appLogs.length === 0) {
                showToast('Ù„Ø§Ú¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }
            appLogs = [];
            log('info', 'System', 'Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
            // Ø§Ú¯Ø± ØµÙØ­Ù‡ Ù„Ø§Ú¯ Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
            if (currentSettingsTab === 'logs') {
                renderSettingsContent();
            }
            showToast('ØªÙ…Ø§Ù… Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
        }
        
        function exportLogs() {
            const logsText = appLogs.map(log => 
                `[${log.time}] ${log.level.toUpperCase()} | ${log.category} | ${log.message}${log.data ? '\n  Data: ' + JSON.stringify(log.data) : ''}`
            ).join('\n\n');
            
            // Ú©Ù¾ÛŒ Ø¨Ù‡ clipboard
            navigator.clipboard.writeText(logsText).then(() => {
                showToast('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´Ø¯Ù†Ø¯');
            }).catch(() => {
                // fallback: Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
                const blob = new Blob([logsText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                showToast('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù†Ø¯');
            });
        }

        // --- FETCH PROMPTS FROM URL ---
        let fetchPromptsPromise = null; // Promise Ø¨Ø±Ø§ÛŒ fetch

        function markPromptsLoadedFromGoogleSheet(sourceUrl) {
            state.promptsLoaded = true;
            const meta = {
                source: 'google_sheet',
                schemaVersion: PROMPTS_SCHEMA_VERSION,
                url: String(sourceUrl || ''),
                fetchedAt: new Date().toISOString()
            };
            try {
                localStorage.setItem('prompts_meta', JSON.stringify(meta));
            } catch {
                // ignore
            }
        }
        
        async function fetchPromptsFromUrl() {
            console.log("ğŸ“Š [Google Sheet] Starting to fetch prompts from Google Sheet...");
            log('info', 'Google Sheet', 'Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet');
            
            const promptsUrl = config.promptsUrl;
            console.log("ğŸ“ [Google Sheet] Prompts URL:", promptsUrl);
            
            if (!promptsUrl) {
                console.log('âš ï¸ [Google Sheet] No prompts URL configured, using defaults');
                log('warn', 'Google Sheet', 'URL ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯');
                // Ø·Ø¨Ù‚ Ø³ÛŒØ§Ø³Øª Ø¬Ø¯ÛŒØ¯: Ø§ÛŒÙ†Ø³ØªØ±Ø§Ú©Ø´Ù† Ø¨Ø§ÛŒØ¯ Ø§Ø² Sheet Ø¨ÛŒØ§ÛŒØ¯.
                // Ø§Ú¯Ø± cache Ù…Ø¹ØªØ¨Ø± Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                state.promptsLoaded = !!loadCachedSheetPrompts();
                if (!state.promptsLoaded) {
                    log('error', 'Google Sheet', 'Ø¨Ø¯ÙˆÙ† Google Sheet Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø¯ (prompt Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª)');
                    showToast('Ø®Ø·Ø§: Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
                }
                return Promise.resolve();
            }

            try {
                // Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: Ø¨Ø¹Ø¶ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ (Ù…Ø«Ù„ opensheet.elk.sh) Ù†Ø³Ø¨Øª Ø¨Ù‡ query string Ø­Ø³Ø§Ø³ Ù‡Ø³ØªÙ†Ø¯
                // Ùˆ Ø§Ú¯Ø± Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª 400 Ø¨Ø¯Ù‡Ù†Ø¯.
                // Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ† Ø§Ø¨ØªØ¯Ø§ Ø¨Ø¯ÙˆÙ† cache-buster Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…. Ú©Ù†ØªØ±Ù„ cache Ø±Ø§ Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡ cache Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
                const primaryUrl = promptsUrl;
                console.log("ğŸŒ [Google Sheet] Fetching prompts from:", primaryUrl);
                console.log("ğŸ”„ [Google Sheet] Fetching data...");

                const response = await fetch(primaryUrl, {
                    // Ù†Ú©ØªÙ‡: Ú¯Ø°Ø§Ø´ØªÙ† header Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª cross-origin Ø¨Ø§Ø¹Ø« preflight (OPTIONS) Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    // Ø¨Ø¹Ø¶ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ (Ù…Ø«Ù„ opensheet.elk.sh) Ù…Ù…Ú©Ù† Ø§Ø³Øª preflight Ø±Ø§ Ù¾Ø§Ø³Ø® Ù†Ø¯Ù‡Ù†Ø¯ Ùˆ Ù†ØªÛŒØ¬Ù‡ "Failed to fetch" Ø´ÙˆØ¯.
                    // Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§ÛŒÙ† Ù…Ø´Ú©Ù„ ÙÙ‚Ø· cache Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ùˆ header Ø§Ø¶Ø§ÙÙ‡ Ù†Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ….
                    cache: 'no-store'
                });
                
                console.log("ğŸ“¡ [Google Sheet] Response status:", response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const sheetData = await response.json();
                console.log("ğŸ“¥ [Google Sheet] Data received. Array length:", sheetData.length);
                console.log("ğŸ“„ [Google Sheet] Full data:", JSON.stringify(sheetData, null, 2));
                log('info', 'Google Sheet', 'Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', {
                    arrayLength: sheetData.length,
                    fullData: JSON.stringify(sheetData).substring(0, 500) + '...'
                });
                
                // ØªØ¨Ø¯ÛŒÙ„ <br> Ø¨Ù‡ Ø®Ø· Ø¬Ø¯ÛŒØ¯
                const convertBrToNewline = (text) => {
                    if (!text) return '';
                    let t = String(text).replace(/<br\s*\/?>/gi, '\n');
                    // Ø§Ú¯Ø± Ø³Ù„ÙˆÙ„ Ú¯ÙˆÚ¯Ù„â€ŒØ´ÛŒØª Ø¨Ù‡ ØµÙˆØ±Øª quoted Ø¨Ø±Ú¯Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ (Ù…Ø«Ù„Ø§Ù‹: "....")ØŒ Ú©ÙˆØªÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ø§ "" escape Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
                    const trimmed = t.trim();
                    if (trimmed.length >= 2 && trimmed.startsWith('"') && trimmed.endsWith('"')) {
                        t = trimmed.slice(1, -1).replace(/""/g, '"');
                    }
                    return t;
                };
                
                // OpenSheet ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø² Ø§Ø´ÛŒØ§Ø¡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯
                // Ù‡Ø± Ø±Ø¯ÛŒÙ ÛŒÚ© Ø´ÛŒØ¡ Ø§Ø³Øª Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ type, mentorProtocol, profileAnalysis
                if (Array.isArray(sheetData) && sheetData.length > 0) {
                    console.log("âœ… [Google Sheet] Valid array received with", sheetData.length, "rows");
                    
                    // Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… type Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
                    console.log("ğŸ” [Google Sheet] All row types:", sheetData.map((row, idx) => `Row ${idx}: "${row.type}"`).join(', '));
                    
                    // Ø±ÙˆØ´ 1: Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±Ø¯ÛŒÙ Ø¨Ø§ type = "System Instruction" (ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…)
                    let systemInstructionRow = sheetData.find(row => 
                        row.type && String(row.type).trim().toLowerCase() === 'system instruction'
                    );
                    
                    // Ø±ÙˆØ´ 2: Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ mentorProtocol Ùˆ profileAnalysis Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (ÙØ±Ù…Øª Ø¬Ø¯ÛŒØ¯)
                    if (!systemInstructionRow) {
                        console.log("ğŸ” [Google Sheet] Trying alternate format with separate rows");
                        const mentorRow = sheetData.find(row => row.type === 'mentorProtocol');
                        const profileRow = sheetData.find(row => row.type === 'profileAnalysis');
                        
                        if (mentorRow || profileRow) {
                            // Ø³Ø§Ø®Øª ÛŒÚ© Ø±Ø¯ÛŒÙ ØªØ±Ú©ÛŒØ¨ÛŒ
                            systemInstructionRow = {
                                type: 'System Instruction (merged)',
                                mentorProtocol: mentorRow ? (mentorRow['System Instruction'] || mentorRow.mentorProtocol) : null,
                                profileAnalysis: profileRow ? (profileRow['System Instruction'] || profileRow.profileAnalysis) : null
                            };
                            console.log("âœ… [Google Sheet] Created merged row from separate type rows");
                            log('info', 'Google Sheet', 'ÙØ±Ù…Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ - ØªØ±Ú©ÛŒØ¨ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§', {
                                mentorFound: !!mentorRow,
                                profileFound: !!profileRow
                            });
                        }
                    }
                    
                    if (systemInstructionRow) {
                        console.log("âœ… [Google Sheet] Found 'System Instruction' row");
                        console.log("ğŸ“‹ [Google Sheet] Row data:", {
                            type: systemInstructionRow.type,
                            hasMentorProtocol: !!systemInstructionRow.mentorProtocol,
                            hasProfileAnalysis: !!systemInstructionRow.profileAnalysis,
                            mentorProtocolLength: systemInstructionRow.mentorProtocol?.length || 0,
                            profileAnalysisLength: systemInstructionRow.profileAnalysis?.length || 0
                        });
                        
                        let updated = false;
                        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§
                        if (systemInstructionRow.mentorProtocol) {
                            const converted = convertBrToNewline(systemInstructionRow.mentorProtocol);
                            console.log("ğŸ“ [Google Sheet] Updating mentorProtocol. Preview:", converted.substring(0, 100) + "...");
                            state.prompts.mentorProtocol = converted;
                            updated = true;
                        }
                        if (systemInstructionRow.profileAnalysis) {
                            const converted = convertBrToNewline(systemInstructionRow.profileAnalysis);
                            console.log("ğŸ“ [Google Sheet] Updating profileAnalysis. Preview:", converted.substring(0, 100) + "...");
                            state.prompts.profileAnalysis = converted;
                            updated = true;
                        }
                        
                        if (updated) {
                            // Ù…Ù†Ø¨Ø¹ Ù†Ù‡Ø§ÛŒÛŒ Ø§ÛŒÙ†Ø³ØªØ±Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§: Google Sheet
                            markPromptsLoadedFromGoogleSheet(promptsUrl);
                            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                            saveData();
                            console.log('âœ… [Google Sheet] Prompts updated and saved to localStorage successfully!');
                            log('success', 'Google Sheet', 'Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
                            // Ø§Ú¯Ø± modal ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
                            const modalCard = document.getElementById('modal-card');
                            if (modalCard && modalCard.innerHTML.includes('set-prompt-main')) {
                                console.log('ğŸ”„ [Google Sheet] Refreshing settings modal...');
                                openSettingsModal();
                            }
                        } else {
                            console.log('âš ï¸ [Google Sheet] No fields to update in System Instruction row');
                        }
                    } else {
                        console.warn('âš ï¸ [Google Sheet] System Instruction row not found, trying first row...');
                        // Ø§Ú¯Ø± Ø±Ø¯ÛŒÙ System Instruction Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ø±Ø¯ÛŒÙ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…
                        const firstRow = sheetData[0];
                        console.log("ğŸ“‹ [Google Sheet] First row data:", {
                            type: firstRow.type,
                            hasMentorProtocol: !!firstRow.mentorProtocol,
                            hasProfileAnalysis: !!firstRow.profileAnalysis
                        });
                        
                        if (firstRow && (firstRow.mentorProtocol || firstRow.profileAnalysis)) {
                            let updated = false;
                            if (firstRow.mentorProtocol) {
                                const converted = convertBrToNewline(firstRow.mentorProtocol);
                                console.log("ğŸ“ [Google Sheet] Updating mentorProtocol from first row. Preview:", converted.substring(0, 100) + "...");
                                state.prompts.mentorProtocol = converted;
                                updated = true;
                            }
                            if (firstRow.profileAnalysis) {
                                const converted = convertBrToNewline(firstRow.profileAnalysis);
                                console.log("ğŸ“ [Google Sheet] Updating profileAnalysis from first row. Preview:", converted.substring(0, 100) + "...");
                                state.prompts.profileAnalysis = converted;
                                updated = true;
                            }
                            if (updated) {
                                // Ù…Ù†Ø¨Ø¹ Ù†Ù‡Ø§ÛŒÛŒ Ø§ÛŒÙ†Ø³ØªØ±Ø§Ú©Ø´Ù†â€ŒÙ‡Ø§: Google Sheet
                                markPromptsLoadedFromGoogleSheet(promptsUrl);
                                saveData();
                                console.log('âœ… [Google Sheet] Prompts updated from first row and saved to localStorage');
                                // Ø§Ú¯Ø± modal ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ø² Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
                                const modalCard = document.getElementById('modal-card');
                                if (modalCard && modalCard.innerHTML.includes('set-prompt-main')) {
                                    console.log('ğŸ”„ [Google Sheet] Refreshing settings modal...');
                                    openSettingsModal();
                                }
                            }
                        } else {
                            console.error('âŒ [Google Sheet] System Instruction row not found and first row is invalid');
                        }
                    }
                } else {
                    console.error('âŒ [Google Sheet] Invalid sheet data format - expected array but got:', typeof sheetData);
                    console.error('âŒ [Google Sheet] Data:', sheetData);
                }
            } catch (error) {
                console.error('âŒ [Google Sheet] Failed to fetch prompts from URL:', error);
                console.error('âŒ [Google Sheet] Error details:', error.message);
                console.error('âŒ [Google Sheet] Error stack:', error.stack);
                const cachedFallback = loadCachedSheetPrompts();
                if (cachedFallback) {
                    state.prompts = cachedFallback.prompts;
                    state.promptsLoaded = true;
                    console.warn('âš ï¸ [Google Sheet] Fetch failed, using cached Sheet prompts');
                    log('warn', 'Google Sheet', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Google Sheet - Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø³Ø®Ù‡ cache Ø´Ø¯Ù‡', { error: error.message });
                } else {
                    state.promptsLoaded = false;
                    console.warn('âš ï¸ [Google Sheet] Fetch failed and no cache available');
                    log('error', 'Google Sheet', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Google Sheet', { error: error.message });
                    showToast('Ø®Ø·Ø§: Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
                }
            }
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        log('info', 'App Init', 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ø³Øª...');
        console.log("ğŸš€ [App Init] Application starting - fetching prompts from Google Sheet...");
        fetchPromptsPromise = fetchPromptsFromUrl(); 

        function saveData() {
            console.log("ğŸ’¾ [Save Data] Saving data to localStorage...");
            // Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ú©Ù‡ Ø§Ø² Google Sheet Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯.
            // Ø§ÛŒÙ† Ú©Ø§Ø± Ø¬Ù„ÙˆÛŒ Ù…Ø§Ù†Ø¯Ú¯Ø§Ø± Ø´Ø¯Ù† Ù¾Ø±Ø§Ù…Ù¾Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ/Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.
            const meta = localStorage.getItem('prompts_meta');
            if (state.promptsLoaded && meta) {
                localStorage.setItem('prompts', JSON.stringify(state.prompts));
            }
            localStorage.setItem('schedule', JSON.stringify(state.schedule));
            localStorage.setItem('profiles', JSON.stringify(state.profiles));
            console.log("âœ… [Save Data] Data saved successfully");
            console.log("ğŸ“Š [Save Data] Prompts preview:", {
                mentorProtocol: state.prompts.mentorProtocol?.substring(0, 80) + "...",
                profileAnalysis: state.prompts.profileAnalysis?.substring(0, 80) + "..."
            });
        }

        function toPersianDigits(input) {
            const str = String(input || '');
            return str.replace(/[0-9]/g, c => String.fromCharCode(c.charCodeAt(0) + 1728));
        }

        function timeToMinutes(t) {
            if (!t) return 0;
            const [h, m] = String(t).split(':').map(x => parseInt(x, 10) || 0);
            return h * 60 + m;
        }

        function router(route) {
            window.scrollTo(0,0);
            document.querySelectorAll('.nav-item').forEach(el => {
                el.className = "nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-slate-400 transition-colors";
            });
            const navEl = document.getElementById(`nav-${route}`);
            if (navEl) navEl.className = "nav-item btn-press flex flex-col items-center justify-center gap-1.5 text-primary transition-colors";

            const app = document.getElementById('app-container');
            app.innerHTML = '';

            if (route === 'home') renderHome(app);
            if (route === 'schedule') renderSchedule(app);
            if (route === 'profiles') renderProfiles(app);
        }

        // --- CUSTOM CONFIRM MODAL LOGIC ---
        function openConfirm(message, callback) {
            confirmCallback = callback;
            const content = `
                <div class="flex flex-col h-full justify-center p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-rose-50 mb-6">
                        <svg class="h-8 w-8 text-rose-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </div>
                    <h3 class="text-xl leading-6 font-black text-slate-800 mb-3">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ø±ÙÛŒÙ‚ØŸ</h3>
                    <p class="text-sm text-slate-500 mb-8 leading-relaxed">${message}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="executeConfirm()" class="btn-press w-full rounded-2xl border border-transparent shadow-lg shadow-rose-100 px-4 py-3.5 bg-rose-500 text-base font-bold text-white hover:bg-rose-600 focus:outline-none">
                            Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†
                        </button>
                        <button onclick="closeModal()" class="btn-press w-full rounded-2xl border border-slate-200 shadow-sm px-4 py-3.5 bg-white text-base font-bold text-slate-700 hover:bg-slate-50 focus:outline-none">
                            Ù†Ù‡ØŒ Ù…Ù†ØµØ±Ù Ø´Ø¯Ù…
                        </button>
                    </div>
                </div>
            `;
            showModal(content);
        }

        function executeConfirm() {
            if (confirmCallback) confirmCallback();
            confirmCallback = null;
            closeModal();
        }

        // --- RENDER VIEWS ---
        function renderHome(container) {
            const currentEvent = getCurrentEvent();
            container.innerHTML = `
                <div class="fade-in space-y-5">
                    <!-- Context Bar -->
                    <div class="bg-white border border-slate-100 rounded-gg p-5 flex items-center justify-between shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-full bg-gradient-to-l from-cyan-50/50 to-transparent"></div>
                        <div class="flex items-center gap-5 w-full relative z-10">
                             <div class="flex flex-col items-center justify-center min-w-[80px]">
                                <span class="text-3xl font-black text-primary font-[Vazirmatn] tracking-tight pt-1">${toPersianDigits(getCurrentTime())}</span>
                                <span class="text-[10px] text-cyan-600 font-bold mt-0.5 opacity-80">Ø¨Ù‡ ÙˆÙ‚Øª Ø¹Ø§Ø´Ù‚ÛŒ</span>
                             </div>
                             
                             <div class="w-px h-10 bg-slate-100"></div>
                             
                             <div class="flex flex-col flex-grow items-start overflow-hidden">
                                 <span class="text-[10px] text-slate-400 font-bold mb-1.5">Ù‡Ù…â€ŒØ§Ú©Ù†ÙˆÙ† Ø¯Ø± Ø³Ù†Ú¯Ø±:</span>
                                 <div class="flex items-center gap-2.5 w-full">
                                    <span class="flex-shrink-0 w-2.5 h-2.5 bg-primary rounded-full animate-pulse shadow-[0_0_10px_rgba(8,145,178,0.4)]"></span>
                                    <span class="text-sm font-bold text-slate-700 truncate w-full leading-tight">${currentEvent ? currentEvent.title : 'ÙØ±ØµØª Ø®Ù„ÙˆØª'}</span>
                                 </div>
                             </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="bg-white p-6 rounded-gg shadow-sm border border-slate-100">
                        <label class="block text-slate-800 font-black mb-4 flex items-center gap-2.5">
                            <div class="bg-cyan-100 p-2 rounded-xl text-primary">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            </div>
                            Ø§ØªØ§Ù‚ ÙÚ©Ø± Ø¬Ù‡Ø§Ø¯ÛŒ
                        </label>
                        <p class="text-xs text-slate-500 mb-4 leading-relaxed bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            Ø³Ù„Ø§Ù… Ø®Ø§Ø¯Ù… Ø¹Ø²ÛŒØ²Ø› Ø¯ØºØ¯ØºÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ ÛŒØ§Ø±Ø§Ù† Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† Ø¯Ø§Ø±ÛŒØŸ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ ØªØ§ Ø¨Ø§ Ù‡Ù… Ø­Ù„Ø´ Ú©Ù†ÛŒÙ…...
                        </p>
                        <textarea id="mentor-input" rows="3" class="w-full bg-white border border-slate-200 rounded-2xl p-4 text-slate-700 placeholder-slate-300 focus:ring-2 focus:ring-cyan-100 focus:border-primary transition-all resize-none text-sm leading-relaxed" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¨Ú†Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ù„Ù‚Ù‡ Ù…Ø¹Ø±ÙØª Ú©Ù…ÛŒ Ø®Ø³ØªÙ‡ Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ù†Ø¯..."></textarea>
                        
                        <button onclick="generateProtocol()" class="btn-press mt-5 w-full bg-primary text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-primary-hover transition-all shadow-lg shadow-cyan-100">
                            <span id="btn-icon" class="text-lg">âœ¨</span>
                            <span id="btn-text">Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ Ùˆ Ø±Ø§Ù‡Ú©Ø§Ø±</span>
                            <div id="btn-loader" class="loader hidden"></div>
                        </button>
                    </div>

                    <!-- Output Area -->
                    <div id="result-area" class="hidden pb-24">
                        <div class="flex items-center gap-2.5 mb-5 px-3 mt-8">
                            <div class="h-6 w-1.5 bg-primary rounded-full"></div>
                            <h2 class="font-bold text-slate-800 text-lg">Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ Ùˆ Ø±Ø§Ù‡Ú©Ø§Ø± Ø¹Ù…Ù„ÛŒØ§ØªÛŒ</h2>
                        </div>
                        <div id="ai-output" class="space-y-4"></div>
                    </div>
                </div>
            `;
        }

        function renderSchedule(container) {
            let html = `
                <div class="fade-in space-y-5">
                    <div class="flex justify-between items-center px-2 mb-2">
                        <div>
                            <h2 class="text-xl font-black text-slate-800">Ù†Ø¸Ù… Ùˆ Ø¬Ù‡Ø§Ø¯</h2>
                            <p class="text-xs text-slate-500 mt-1">Ø³ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</p>
                        </div>
                        <button onclick="addScheduleItem()" class="btn-press bg-primary text-white px-4 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-100 hover:bg-primary-hover transition-all flex items-center gap-1.5">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯
                        </button>
                    </div>

                    <div class="space-y-3 pb-24">
            `;

            state.schedule.sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));

            state.schedule.forEach((item, index) => {
                html += `
                    <div class="bg-white p-2.5 pl-4 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-3 transition-all hover:border-cyan-100">
                        <div class="relative min-w-[75px] text-center">
                            <input 
                                type="text"
                                value="${item.time}"
                                inputmode="numeric"
                                placeholder="00:00"
                                onblur="updateSchedule(${index}, 'time', normalizeTimeInput(this.value))"
                                class="w-full text-center bg-transparent text-primary font-black text-lg tracking-tight outline-none focus:outline-none"
                                aria-label="Ø²Ù…Ø§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ (HH:MM)"
                            />
                        </div>
                        
                        <div class="flex-grow">
                            <input type="text" value="${item.title.replace(/"/g,'&quot;')}" 
                                onchange="updateSchedule(${index}, 'title', this.value)"
                                class="w-full font-bold text-slate-700 bg-transparent border-none focus:ring-0 p-0 placeholder-slate-300 text-sm" 
                                placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡">
                        </div>

                        <!-- Small Delete X -->
                        <button onclick="deleteSchedule(${index})" class="text-slate-300 hover:text-rose-400 p-2 rounded-full hover:bg-rose-50 transition-colors btn-press">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </button>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
            autoResizeAllTextareas(container);
        }

        function renderProfiles(container) {
            let html = `
                <div class="fade-in space-y-5">
                    <div class="flex justify-between items-end px-2 mb-2">
                        <div>
                            <h2 class="text-xl font-black text-slate-800">Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§</h2>
                            <p class="text-xs text-slate-500 mt-1">Ø¯ÛŒØ¯Ù‡â€ŒØ¨Ø§Ù†ÛŒ Ø±Ø´Ø¯ ÛŒØ§Ø±Ø§Ù†</p>
                        </div>
                        <button onclick="openAddProfileModal()" class="btn-press bg-primary text-white px-4 py-2.5 rounded-2xl text-xs font-bold shadow-lg shadow-cyan-100 hover:bg-primary-hover transition-colors flex items-center gap-1.5">
                            <span>+</span>
                            <span>Ø³Ø±Ø¨Ø§Ø² Ø¬Ø¯ÛŒØ¯</span>
                        </button>
                    </div>
                    <div class="space-y-6 pb-24">
            `;

            if (state.profiles.length === 0) {
                html += `<div class="text-center text-slate-400 py-16 flex flex-col items-center gap-3">
                    <span class="text-4xl opacity-20">ğŸŒ±</span>
                    <span class="text-sm">Ù‡Ù†ÙˆØ² Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒØ§ÛŒ ØªØ´Ú©ÛŒÙ„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</span>
                </div>`;
            }

            state.profiles.forEach((p, idx) => {
                const logs = p.logs || [];
                
                html += `
                    <div class="bg-white rounded-[1.75rem] shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50/60 p-5 flex justify-between items-center border-b border-slate-100">
                            <div class="flex items-center gap-3.5">
                                <div class="w-11 h-11 rounded-full bg-white border border-slate-200 flex items-center justify-center font-black text-primary shadow-sm text-lg">
                                    ${p.name[0] || ''}
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800 text-base">${p.name}</div>
                                    <div class="text-[10px] text-slate-400 font-bold bg-white px-2 py-0.5 rounded-full inline-block border border-slate-100 mt-0.5">${toPersianDigits(String(p.age))} Ø³Ø§Ù„Ù‡</div>
                                </div>
                            </div>
                            <!-- Small Delete X -->
                            <button onclick="deleteProfile(${idx})" class="p-2 text-slate-300 hover:text-rose-400 transition-colors btn-press">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                            </button>
                        </div>

                        <div class="p-5 bg-white">
                             <div class="timeline-container">
                                <div class="timeline-line"></div>
                                <div class="space-y-7">
                                    ${logs.map((log, logIdx) => {
                                        const isAi = log.type === 'ai';
                                        return `
                                        <div class="timeline-item group">
                                            <div class="timeline-dot ${isAi ? 'ai' : 'user'}"></div>
                                            <div class="flex justify-between items-center mb-2 pl-1">
                                                <div class="relative group/time bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">
                                                    <span class="text-[10px] font-bold ${isAi ? 'text-amber-600' : 'text-primary'}">
                                                        ${toPersianDigits(log.time)}
                                                    </span>
                                                    <input type="time" value="${log.time}" 
                                                        onchange="updateLog(${idx}, ${logIdx}, 'time', this.value)"
                                                        class="absolute inset-0 opacity-0 w-full h-full cursor-pointer">
                                                </div>
                                                
                                                <div class="flex items-center gap-1.5">
                                                    ${isAi ? '<span class="text-[9px] bg-amber-50 text-amber-600 px-2 py-0.5 rounded-md font-bold border border-amber-100">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</span>' : ''}
                                                    <!-- Small Delete X -->
                                                    <button onclick="deleteLog(${idx}, ${logIdx})" class="text-slate-300 hover:text-rose-400 transition-colors p-1.5 btn-press">
                                                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
                                                    </button>
                                                </div>
                                            </div>

                                            <textarea 
                                                onchange="updateLog(${idx}, ${logIdx}, 'note', this.value)"
                                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                                class="w-full text-sm leading-7 ${isAi ? 'bg-amber-50 border-amber-100 text-amber-900' : 'bg-slate-50 border-slate-100 text-slate-600'} p-3.5 rounded-2xl rounded-tr-sm border shadow-sm focus:bg-white focus:ring-1 focus:ring-cyan-200 focus:text-slate-800 transition-all resize-none overflow-hidden placeholder-slate-300 min-h-[56px] focus:outline-none auto-resize-textarea whitespace-pre-wrap break-words overflow-hidden"
                                                >${log.note.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                            
                            <div class="mt-8 pt-5 border-t border-dashed border-slate-200 flex gap-2.5">
                                <input type="text" id="log-input-${idx}" 
                                    class="flex-grow bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3.5 text-sm focus:ring-2 focus:ring-cyan-100 focus:bg-white focus:border-primary transition-all"
                                    placeholder="Ø«Ø¨Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯..."
                                    onkeydown="if(event.key === 'Enter') addLog(${idx})">
                                <button onclick="addLog(${idx})" class="btn-press bg-primary text-white w-12 rounded-2xl flex items-center justify-center hover:bg-primary-hover shadow-lg shadow-cyan-100 transition-colors">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
                                </button>
                            </div>

                            <button onclick="analyzeProfile(${idx})" id="analyze-btn-${idx}" class="btn-press mt-3 w-full bg-orange-500 text-white py-3.5 rounded-2xl text-xs font-bold hover:bg-orange-600 shadow-lg shadow-orange-100 transition-all flex items-center justify-center gap-2 group">
                                <svg class="w-4 h-4 text-white group-hover:rotate-12 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                <span>ØªØ­Ù„ÛŒÙ„ Ø®Ø§Ø¯Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
                            </button>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            container.innerHTML = html;
            autoResizeAllTextareas(container);
        }

        
        function autoResizeAllTextareas(scope=document) {
            try {
                const els = scope.querySelectorAll('textarea.auto-resize-textarea');
                els.forEach(el => {
                    el.style.height = '';
                    el.style.height = (el.scrollHeight) + 'px';
                });
            } catch {}
        }
// --- CORE LOGIC ---
        // Ø³Ø§Ø®Øª Ù¾Ø±Ø§Ù…Ù¾Øª: Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ† ÙØ±Ù…Øª Ø±Ø§ Ø¯Ø³Øª Ù†Ø²Ù†ÛŒØ¯ (Ø·Ø¨Ù‚ Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ)
        function buildMentorUserPrompt(timeNow, currentEventTitle, mentorInput, studentsArr) {
            return `Ø¬Ø²Ø¦ÛŒØ§Øª User Prompt:\nTime: ${timeNow}\nCurrent Event: ${currentEventTitle}\nUser (Mentor) Input: ${mentorInput}\nStudents: ${JSON.stringify(studentsArr)}`;
        }

        async function generateProtocol() {
            log('info', 'Generate Protocol', 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ');
            console.log("ğŸš€ [Generate Protocol] Function called");

            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            const outputArea = document.getElementById('result-area');
            const aiOutput = document.getElementById('ai-output');

            // Ù†ØªÛŒØ¬Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ú©Ù„ scope ØªØ§Ø¨Ø¹ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨Ø§Ø´Ø¯
            let result = null;

            try {
                // Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù† ØªØ§ fetch Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯
                if (fetchPromptsPromise) {
                    console.log("â³ [Generate Protocol] Waiting for prompts to load...");
                    await fetchPromptsPromise;
                    console.log("âœ… [Generate Protocol] Prompts loaded");
                }

                if (!state.promptsLoaded) {
                    showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯');
                    throw new Error('PromptsNotLoaded');
                }

                const inputEl = document.getElementById('mentor-input');
                const input = inputEl ? inputEl.value : '';
                console.log("ğŸ“ [Generate Protocol] User input:", input);

                if (!input.trim()) {
                    console.log("âš ï¸ [Generate Protocol] Empty input - showing toast");
                    return showToast('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ Ø¯ØºØ¯ØºÙ‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯');
                }

                console.log("ğŸ”„ [Generate Protocol] Updating UI - showing loader");
                if (btnText) btnText.classList.add('hidden');
                if (btnLoader) btnLoader.classList.remove('hidden');
                if (outputArea) outputArea.classList.add('hidden');

                const timeNow = getCurrentTime();
                const currentEvent = getCurrentEvent();
                const currentEventTitle = currentEvent ? currentEvent.title : 'Free Time';

                const safeProfiles = state.profiles.map(p => ({
                    name: p.name,
                    age: p.age,
                    recent_log: (p.logs && p.logs.length) ? (p.logs[p.logs.length - 1]?.note || "Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª") : "Ø¨Ø¯ÙˆÙ† Ø«Ø¨Øª"
                }));

                console.log("ğŸ“‹ [Generate Protocol] Context:", { time: timeNow, event: currentEventTitle, profiles: safeProfiles.length });

                // IMPORTANT: ÙØ±Ù…Øª Ù¾Ø±Ø§Ù…Ù¾Øª Ù…Ø·Ø§Ø¨Ù‚ Ù†Ø³Ø®Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒ
                const userPrompt = buildMentorUserPrompt(timeNow, currentEventTitle, input, safeProfiles);

                console.log("ğŸ¤– [Generate Protocol] Calling AI...");
                log('info', 'Generate Protocol', 'ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ', {
                    userPromptPreview: userPrompt.substring(0, 150) + '...',
                    systemPromptPreview: state.prompts.mentorProtocol.substring(0, 150) + '...'
                });

                const rawText = await callGemini(userPrompt, state.prompts.mentorProtocol);
                console.log("âœ… [Generate Protocol] AI response received");
                log('info', 'Generate Protocol', 'Ù¾Ø§Ø³Ø® AI Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', {
                    rawTextPreview: String(rawText).substring(0, 300) + '...',
                    rawTextLength: String(rawText).length
                });

                try {
                    const clean = String(rawText).replace(/```json\n?|```/g, '').trim();
                    result = typeof clean === 'string' ? JSON.parse(clean) : clean;
                    console.log("âœ… [Generate Protocol] JSON parsed successfully:", result);
                    log('success', 'Generate Protocol', 'JSON Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ø±Ø³ Ø´Ø¯', {
                        hasSections: Array.isArray(result?.sections),
                        sectionsCount: Array.isArray(result?.sections) ? result.sections.length : null
                    });
                } catch (e) {
                    console.error("âŒ [Generate Protocol] JSON parse error:", e);
                    console.log("ğŸ“„ [Generate Protocol] Raw text:", rawText);
                    log('error', 'Generate Protocol', 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø±Ø³ JSON', {
                        error: e.message,
                        rawText: String(rawText).substring(0, 500)
                    });
                    result = { sections: [ { title: "Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øª Ø®Ø±ÙˆØ¬ÛŒ", content: String(rawText) } ] };
                }

                // --- Render ---
                console.log("ğŸ¨ [Generate Protocol] Rendering results...");

                const sections = normalizeProtocolSections(result);

                // Ø§Ú¯Ø± Ù…Ø¯Ù„ Ø®Ø±ÙˆØ¬ÛŒÙ Ø¯Ø±Ø³Øª Ù†Ø¯Ø§Ø¯ØŒ ÛŒÚ© Ú©Ø§Ø±Øª Ø®Ø·Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                const safeSections = (sections && sections.length) ? sections : [
                    { title: "Ø®Ø·Ø§", content: "Ø®Ø±ÙˆØ¬ÛŒ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ù†Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯." }
                ];

                const html = safeSections.map((sec, idx) => {
                    const st = PROTOCOL_SECTION_STYLES[idx % PROTOCOL_SECTION_STYLES.length];
                    const title = escapeHtml(sec.title);
                    const content = escapeHtml(sec.content);

                    return `
                        <div class="protocol-card ${st.border}">
                            <div class="${st.headBg} p-4 font-bold ${st.headText} text-sm flex items-center gap-2.5 border-b ${st.headBorder}">
                                <span class="text-xl">${st.icon}</span> ${title}
                            </div>
                            <div class="p-5 text-sm leading-8 text-slate-700 bg-white">${content}</div>
                        </div>
                    `;
                }).join('\n');

                if (aiOutput) aiOutput.innerHTML = html;
                if (outputArea) {
                    outputArea.classList.remove('hidden');
                    outputArea.scrollIntoView({ behavior: 'smooth' });
                }

                console.log("âœ… [Generate Protocol] Success! Results displayed");
                log('success', 'Generate Protocol', 'Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯');

            } catch (error) {
                console.error("âŒ [Generate Protocol] Fatal error:", error);
                console.error("âŒ [Generate Protocol] Error stack:", error.stack);
                log('error', 'Generate Protocol', 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ', { error: error.message });
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø®Ø§Ø¯Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯.');
            } finally {
                // Ù…Ù‡Ù…: Ø¯Ø± Ù‡Ø± Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø¬Ù…Ø¹ Ø´ÙˆØ¯
                if (btnText) btnText.classList.remove('hidden');
                if (btnLoader) btnLoader.classList.add('hidden');
            }
        }

        async function analyzeProfile(index) {
            console.log("ğŸ” [Analyze Profile] Function called for profile index:", index);
            log('info', 'Analyze Profile', `ØªØ­Ù„ÛŒÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø´Ù…Ø§Ø±Ù‡ ${index + 1}`);

            const btn = document.getElementById(`analyze-btn-${index}`);
            const originalContent = btn ? btn.innerHTML : null;

            try {
                // Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù† ØªØ§ fetch Ú©Ø§Ù…Ù„ Ø´ÙˆØ¯
                if (fetchPromptsPromise) {
                    console.log("â³ [Analyze Profile] Waiting for prompts to load...");
                    await fetchPromptsPromise;
                    console.log("âœ… [Analyze Profile] Prompts loaded");
                }
                if (!state.promptsLoaded) {
                    showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Google Sheet Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯');
                    throw new Error('PromptsNotLoaded');
                }
                
                if (!btn) {
                    console.error("âŒ [Analyze Profile] Button not found");
                    return showToast('Ø¯Ú©Ù…Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
                const profile = state.profiles[index];
                console.log("ğŸ‘¤ [Analyze Profile] Profile:", profile.name);

                btn.disabled = true;
                btn.innerHTML = `<div class="loader w-4 h-4 border-white border-b-transparent"></div> <span>Ø¯Ø± Ø­Ø§Ù„ ØªÙÚ©Ø±...</span>`;

                const userPrompt = `
                    Profile Data:
                    Name: ${profile.name}
                    Age: ${profile.age}
                    Full Logs (Chronological): ${JSON.stringify(profile.logs)}
                `;

                console.log("ğŸ¤– [Analyze Profile] Calling AI...");
                const rawText = await callGemini(userPrompt, state.prompts.profileAnalysis);
                console.log("âœ… [Analyze Profile] AI response received");

                let result;
                try {
                     let clean = String(rawText).replace(/```json\n?|```/g, '').trim();
                     result = JSON.parse(clean);
                     console.log("âœ… [Analyze Profile] JSON parsed successfully:", result);
                } catch (e) {
                    console.error("âŒ [Analyze Profile] JSON parse error:", e);
                    console.log("ğŸ“„ [Analyze Profile] Raw text:", rawText);
                    result = { sentiment: "ØªØ­Ù„ÛŒÙ„ Ù…ØªÙ†ÛŒ", advice: String(rawText) };
                }

                const newLog = {
                    time: getCurrentTime(),
                    note: `[${result.sentiment}]: ${result.advice}`,
                    type: 'ai'
                };

                state.profiles[index].logs.push(newLog);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¯Ø± Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø«Ø¨Øª Ø´Ø¯');
                console.log("âœ… [Analyze Profile] Success! Log added to profile");
                log('success', 'Analyze Profile', 'ØªØ­Ù„ÛŒÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯');

            } catch (error) {
                console.error("âŒ [Analyze Profile] Error:", error);
                console.error("âŒ [Analyze Profile] Error stack:", error.stack);
                log('error', 'Analyze Profile', 'Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡', { error: error.message });
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„.');
            } finally {
                // Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ù‡Ø± Ø­Ø§Ù„Øª Ø¨Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ú¯Ø±Ø¯Ø¯
                if (btn && originalContent !== null) {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }
        }

        
        function normalizeTimeInput(v) {
            // Normalize user-typed time into HH:MM. Keeps UI unchanged, only fixes value.
            let s = String(v || '').trim();
            if (!s) return '00:00';
            // Convert Persian digits to English
            const map = { 'Û°':'0','Û±':'1','Û²':'2','Û³':'3','Û´':'4','Ûµ':'5','Û¶':'6','Û·':'7','Û¸':'8','Û¹':'9' };
            s = s.replace(/[Û°-Û¹]/g, ch => map[ch] || ch);

            // If user typed 4 digits like 930 -> 09:30 or 1230 -> 12:30
            const digits = s.replace(/[^0-9]/g, '');
            if (digits.length === 3) {
                s = '0' + digits[0] + ':' + digits.slice(1);
            } else if (digits.length === 4) {
                s = digits.slice(0,2) + ':' + digits.slice(2);
            } else if (/^\d{1,2}:\d{1,2}$/.test(s)) {
                // keep
            } else if (digits.length >= 1 && digits.length <= 2) {
                // hour only
                s = digits.padStart(2,'0') + ':00';
            } else {
                // fallback
                s = '00:00';
            }

            const parts = s.split(':');
            let hh = parseInt(parts[0] || '0', 10);
            let mm = parseInt(parts[1] || '0', 10);
            if (Number.isNaN(hh)) hh = 0;
            if (Number.isNaN(mm)) mm = 0;
            hh = Math.max(0, Math.min(23, hh));
            mm = Math.max(0, Math.min(59, mm));
            return String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
        }
// --- CRUD ---
        function updateSchedule(index, field, value) {
            state.schedule[index][field] = value;
            if (field === 'time') {
                state.schedule.sort((a,b) => timeToMinutes(a.time) - timeToMinutes(b.time));
                saveData();
                renderSchedule(document.getElementById('app-container'));
            } else {
                saveData();
            }
        }

        function deleteSchedule(index) {
            openConfirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø² Ø³ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ', () => {
                state.schedule.splice(index, 1);
                saveData();
                renderSchedule(document.getElementById('app-container'));
                showToast('Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            });
        }

        function addScheduleItem() {
            state.schedule.push({ id: Date.now(), time: "00:00", title: "" });
            saveData();
            renderSchedule(document.getElementById('app-container'));
        }

        function updateLog(profileIndex, logIndex, field, value) {
            if (field === 'note' && !String(value).trim()) return;
            state.profiles[profileIndex].logs[logIndex][field] = value;
            saveData();
        }

        function deleteLog(profileIndex, logIndex) {
            openConfirm('Ø¢ÛŒØ§ Ø§ÛŒÙ† Ø«Ø¨Øª Ø§Ø² Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ', () => {
                state.profiles[profileIndex].logs.splice(logIndex, 1);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('Ø«Ø¨Øª Ø­Ø°Ù Ø´Ø¯');
            });
        }

        function addLog(index) {
            const input = document.getElementById(`log-input-${index}`);
            const val = input ? input.value.trim() : '';
            if(!val) return;

            state.profiles[index].logs.push({
                time: getCurrentTime(),
                note: val,
                type: 'user'
            });
            saveData();
            if (input) input.value = '';
            renderProfiles(document.getElementById('app-container'));
        }

        function deleteProfile(index) {
            openConfirm('Ø¢ÛŒØ§ Ú©Ù„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø§ÛŒÙ† Ø³Ø±Ø¨Ø§Ø² Ø­Ø°Ù Ø´ÙˆØ¯ØŸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.', () => {
                state.profiles.splice(index, 1);
                saveData();
                renderProfiles(document.getElementById('app-container'));
                showToast('Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ (Ø­Ø°Ù) Ø´Ø¯');
            });
        }

        function resetFactory() {
            openConfirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯.', () => {
                localStorage.clear();
                location.reload();
            });
        }

        // --- SETTINGS & MODALS ---
        let currentSettingsTab = 'prompts'; // prompts, logs, about
        
        function switchSettingsTab(tab) {
            currentSettingsTab = tab;
            renderSettingsContent();
        }
        
        function renderSettingsContent() {
            const container = document.getElementById('settings-tab-content');
            if (!container) return;
            
            // Update tab buttons
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-primary', 'text-primary');
                btn.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById(`tab-btn-${currentSettingsTab}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-slate-400');
                activeBtn.classList.add('border-b-2', 'border-primary', 'text-primary');
            }
            
            if (currentSettingsTab === 'prompts') {
                container.innerHTML = renderPromptsTab();
            } else if (currentSettingsTab === 'logs') {
                container.innerHTML = renderLogsTab();
            } else if (currentSettingsTab === 'about') {
                container.innerHTML = renderAboutTab();
            }
        }
        
        function renderPromptsTab() {
            return `
                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2 flex items-center gap-1.5">
                            <span class="text-lg">âš¡</span> Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø§ØªØ§Ù‚ ÙÚ©Ø± (Protocol Prompt)
                        </label>
                        <textarea id="set-prompt-main" readonly class="w-full text-xs p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:border-primary focus:bg-white focus:outline-none font-mono leading-relaxed shadow-inner text-slate-600 cursor-not-allowed" rows="6">${escapeHtml(state.prompts.mentorProtocol || '')}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2 flex items-center gap-1.5">
                            <span class="text-lg">ğŸ§ </span> Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ ØªØ­Ù„ÛŒÙ„ Ù¾Ø±ÙˆÙ†Ø¯Ù‡ (System Prompt)
                        </label>
                        <textarea id="set-prompt-profile" readonly class="w-full text-xs p-4 border border-slate-200 rounded-2xl bg-slate-50 focus:border-primary focus:bg-white focus:outline-none font-mono leading-relaxed shadow-inner text-slate-600 cursor-not-allowed" rows="6">${escapeHtml(state.prompts.profileAnalysis || '')}</textarea>
                    </div>
                    
                    <div class="pt-2 space-y-3">
                        <button onclick="refreshPrompts()" class="btn-press w-full bg-blue-500 text-white py-3.5 rounded-2xl font-bold hover:bg-blue-600 transition-colors shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            <span>Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§</span>
                        </button>
                        <button onclick="saveSettings()" class="btn-press w-full bg-primary text-white py-3.5 rounded-2xl font-bold hover:bg-primary-hover transition-colors shadow-lg shadow-cyan-100">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                    </div>
                </div>
            `;
        }
        
        function renderLogsTab() {
            if (appLogs.length === 0) {
                return `
                    <div class="text-center py-16 text-slate-400">
                        <div class="text-6xl mb-4 opacity-20">ğŸ“‹</div>
                        <p class="text-sm">Ù‡Ù†ÙˆØ² Ù„Ø§Ú¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p class="text-xs mt-2">Ø§Ø² Ù‚Ø³Ù…Øª Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ ØªØ§ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø«Ø¨Øª Ø´ÙˆÙ†Ø¯</p>
                    </div>
                `;
            }
            
            const logsHtml = appLogs.map(logEntry => {
                const levelColors = {
                    'info': 'bg-blue-50 border-blue-200 text-blue-700',
                    'success': 'bg-green-50 border-green-200 text-green-700',
                    'warn': 'bg-orange-50 border-orange-200 text-orange-700',
                    'error': 'bg-red-50 border-red-200 text-red-700'
                };
                const levelEmojis = {
                    'info': 'ğŸ”µ',
                    'success': 'âœ…',
                    'warn': 'âš ï¸',
                    'error': 'âŒ'
                };
                
                const colorClass = levelColors[logEntry.level] || 'bg-slate-50 border-slate-200 text-slate-700';
                const emoji = levelEmojis[logEntry.level] || 'â„¹ï¸';
                
                return `
                    <div class="border ${colorClass} rounded-2xl p-3 text-xs font-mono">
                        <div class="flex items-center gap-2 mb-1 flex-wrap">
                            <span class="text-base">${emoji}</span>
                            <span class="font-bold text-[10px] opacity-60">${logEntry.time}</span>
                            <span class="font-bold text-[10px] bg-white/50 px-2 py-0.5 rounded">${logEntry.category}</span>
                            <span class="font-bold text-[10px] uppercase opacity-40">${logEntry.level}</span>
                        </div>
                        <div class="mr-6 leading-relaxed">${escapeHtml(logEntry.message)}</div>
                        ${logEntry.data ? `<div class="mr-6 mt-2 text-[10px] bg-white/50 p-2 rounded overflow-auto max-h-32 whitespace-pre-wrap">${escapeHtml(JSON.stringify(logEntry.data, null, 2))}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="space-y-3">
                    <div class="flex gap-2 mb-4">
                        <button onclick="refreshLogsView()" class="btn-press flex-1 bg-cyan-500 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-cyan-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            <span>Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>
                        </button>
                        <button onclick="exportLogs()" class="btn-press flex-1 bg-slate-600 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-slate-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            <span>Ú©Ù¾ÛŒ</span>
                        </button>
                        <button onclick="clearLogs()" class="btn-press flex-1 bg-rose-500 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-rose-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                            <span>Ù¾Ø§Ú©</span>
                        </button>
                    </div>
                    <div class="text-xs text-slate-500 mb-3 px-2 flex justify-between items-center">
                        <span><span class="font-bold">${toPersianDigits(appLogs.length)}</span> Ù„Ø§Ú¯ Ø«Ø¨Øª Ø´Ø¯Ù‡</span>
                        <span class="text-[10px]">Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø¯Ø± Ø¨Ø§Ù„Ø§</span>
                    </div>
                    <div id="logs-scroll-container" class="space-y-2 max-h-[500px] overflow-y-auto custom-scrollbar">
                        ${logsHtml}
                    </div>
                </div>
            `;
        }
        
        function refreshLogsView() {
            if (currentSettingsTab === 'logs') {
                renderSettingsContent();
                showToast('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
            }
        }
        
        function renderAboutTab() {
            return `
                <div class="space-y-4">
                    <a href="https://taavonafarin.ir/etekaf/darsname" target="_blank" class="block group">
                        <div class="bg-gradient-to-br from-rose-50 to-white border border-rose-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                            <div class="flex items-center gap-4">
                                <div class="bg-rose-100 p-3 rounded-2xl text-rose-600 group-hover:bg-rose-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm group-hover:text-rose-700 transition-colors">Ø¯Ø±Ø³Ù†Ø§Ù…Ù‡ Ø¬Ø§Ù…Ø¹ Ù…Ø±Ø¨ÛŒØ§Ù†</h4>
                                    <p class="text-[10px] text-slate-500 mt-1">Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø³Ù†Ø¯ ØªØ¹Ø§Ù…Ù„ÛŒ Ø§ØµÙˆÙ„ ØªØ±Ø¨ÛŒØªÛŒ Ø§Ø¹ØªÚ©Ø§Ù</p>
                                </div>
                                <div class="mr-auto text-rose-300 group-hover:text-rose-500">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                </div>
                            </div>
                        </div>
                    </a>
                    <div class="mt-3">
                        <div class="bg-slate-50/60 border border-slate-100 rounded-3xl p-3 space-y-3">
                            <div class="text-[11px] font-bold text-slate-500 px-1">Ù¾ÛŒÙˆÙ†Ø¯Ù‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ÛŒ</div>
                            <a href="https://taavonafarin.ir" target="_blank" class="block group">
                        <div class="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                            <div class="flex items-center gap-4">
                                <div class="bg-blue-100 p-3 rounded-2xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors relative">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-white"></span>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm group-hover:text-blue-700 transition-colors">Ù…Ø¹Ø±ÙÛŒ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ†ÛŒ</h4>
                                    <p class="text-[10px] text-slate-500 mt-1">ÙˆØ¨Ø³Ø§ÛŒØª Ú¯Ø±ÙˆÙ‡ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ†</p>
                                </div>
                                <div class="mr-auto text-blue-300 group-hover:text-blue-500">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                </div>
                            </div>
                        </div>
                    </a>
                    <a href="https://eitaa.com/taavonafarin" target="_blank" class="block group">
                        <div class="bg-gradient-to-br from-orange-50 to-white border border-orange-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                            <div class="flex items-center gap-4">
                                <div class="bg-orange-100 p-3 rounded-2xl text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm group-hover:text-orange-700 transition-colors">Ú¯Ø±ÙˆÙ‡ ØªÙÚ©Ø± ØªØ¹Ø§ÙˆÙ† Ø¢ÙØ±ÛŒÙ† Ø¯Ø± Ø§ÛŒØªØ§</h4>
                                    <p class="text-[10px] text-slate-500 mt-1">Ø¨Ø§ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú¯Ø±ÙˆÙ‡ØŒ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ø±ÙˆØ² Ø¨Ù…Ø§Ù†ÛŒØ¯</p>
                                </div>
                                <div class="mr-auto text-orange-300 group-hover:text-orange-500">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                </div>
                            </div>
                        </div>
                    </a>
                    <a href="https://eitaa.com/yoosof_e_zahra" target="_blank" class="block group">
                        <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-3xl p-4 shadow-sm group-hover:shadow-md transition-all group-active:scale-95">
                            <div class="flex items-center gap-4">
                                <div class="bg-purple-100 p-3 rounded-2xl text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm group-hover:text-purple-700 transition-colors">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ùˆ Ù†Ø¸Ø±Ø§Øª</h4>
                                    <p class="text-[10px] text-slate-500 mt-1">Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ù…Ø§ Ø¨Ø±Ø³Ø§Ù†ÛŒØ¯</p>
                                </div>
                                <div class="mr-auto text-purple-300 group-hover:text-purple-500">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                                </div>
                            </div>
                        </div>
                    </a>
                    <div class="pt-4 space-y-3">
                        <button onclick="closeModal()" class="btn-press w-full text-slate-400 py-2 text-sm font-bold hover:text-slate-600">Ø¨Ø³ØªÙ†</button>
                        <div class="flex justify-center">
                            <button onclick="resetFactory()" class="text-[10px] text-rose-300 hover:text-rose-500 transition-colors">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡</button>
                        </div>
                    </div>
                
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function openSettingsModal() {
            // Ø§Ú¯Ø± fetch Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³ØªØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†
            if (fetchPromptsPromise) {
                await fetchPromptsPromise;
            }
            
            // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ state Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª (Ø§Ø² localStorage Ø¨Ø®ÙˆØ§Ù†)
            const savedPrompts = JSON.parse(localStorage.getItem('prompts'));
            if (savedPrompts) {
                state.prompts = savedPrompts;
            }
            
            currentSettingsTab = 'prompts'; // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªØ¨ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            
            const modalContent = `
                <div class="h-full flex flex-col bg-white">
                    <!-- Header Ø¨Ø§ ØªØ¨â€ŒÙ‡Ø§ -->
                    <div class="border-b border-slate-100 bg-white/95 backdrop-blur-sm">
                        <div class="p-5 pb-0">
                            <h3 class="font-black text-xl text-slate-800">Ø¬Ø¹Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø± Ø®Ø§Ø¯Ù…</h3>
                            <p class="text-xs text-slate-400 mt-1 mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§ØªØŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ùˆ Ø¯Ø±Ø¨Ø§Ø±Ù‡</p>
                        </div>
                        <!-- ØªØ¨â€ŒÙ‡Ø§ -->
                        <div class="flex gap-1 px-3">
                            <button 
                                id="tab-btn-prompts" 
                                onclick="switchSettingsTab('prompts')" 
                                class="settings-tab-btn btn-press flex-1 py-3 text-sm font-bold border-b-2 border-primary text-primary transition-colors">
                                <span class="text-base mr-1">âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                            </button>
                            <button 
                                id="tab-btn-logs" 
                                onclick="switchSettingsTab('logs')" 
                                class="settings-tab-btn btn-press flex-1 py-3 text-sm font-bold border-b-2 border-transparent text-slate-400 transition-colors">
                                <span class="text-base mr-1">ğŸ“‹</span> Ù„Ø§Ú¯â€ŒÙ‡Ø§
                            </button>
                            <button 
                                id="tab-btn-about" 
                                onclick="switchSettingsTab('about')" 
                                class="settings-tab-btn btn-press flex-1 py-3 text-sm font-bold border-b-2 border-transparent text-slate-400 transition-colors">
                                <span class="text-base mr-1">â„¹ï¸</span> Ø¯Ø±Ø¨Ø§Ø±Ù‡
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØªØ¨ -->
                    <div id="settings-tab-content" class="flex-1 overflow-y-auto custom-scrollbar p-5 pb-28">
                        ${renderPromptsTab()}
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        async function refreshPrompts() {
            console.log("ğŸ”„ [Refresh Prompts] Manual refresh triggered by user");
            showToast('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§...');
            
            try {
                // fetch Ø¬Ø¯ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
                console.log("ğŸ“Š [Refresh Prompts] Starting new fetch...");
                fetchPromptsPromise = fetchPromptsFromUrl();
                await fetchPromptsPromise;
                console.log("âœ… [Refresh Prompts] Fetch completed successfully");
                
                // modal Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
                console.log("ğŸ”„ [Refresh Prompts] Refreshing settings modal...");
                openSettingsModal();
                
                showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯');
                console.log("âœ… [Refresh Prompts] Process completed successfully");
            } catch (error) {
                console.error("âŒ [Refresh Prompts] Error during refresh:", error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§');
            }
        }

        function saveSettings() {
            // Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÛŒØ³ØªÙ†Ø¯ Ùˆ Ø§Ø² URL Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
            // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø´Ø¯Ù‡
            closeModal();
            showToast('Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÛŒØ³ØªÙ†Ø¯');
        }

        function openAddProfileModal() {
            const modalContent = `
                <div class="h-full overflow-y-auto bg-white custom-scrollbar flex flex-col">
                    <div class="p-6 text-center">
                        <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-cyan-50 mb-6 text-2xl">
                            ğŸŒ±
                        </div>
                        <h3 class="text-xl leading-6 font-black text-slate-800 mb-2">Ø³Ø±Ø¨Ø§Ø² Ø¬Ø¯ÛŒØ¯</h3>
                        <p class="text-sm text-slate-400 mb-6">Ù…Ø´Ø®ØµØ§Øª ÛŒØ§Ø± Ø¬Ø¯ÛŒØ¯ Ø§Ù…Ø§Ù… Ø²Ù…Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
                        
                        <div class="space-y-4 mb-6 text-right">
                            <div>
                                <input id="new-profile-name" class="w-full p-4 rounded-2xl border border-slate-200 bg-slate-50 text-center font-bold text-slate-700 focus:bg-white focus:border-primary focus:outline-none transition-all" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
                            </div>
                            <div>
                                <input id="new-profile-age" type="number" min="1" class="w-full p-4 rounded-2xl border border-slate-200 bg-slate-50 text-center text-slate-700 focus:bg-white focus:border-primary focus:outline-none transition-all" placeholder="Ø³Ù† (Ø³Ø§Ù„)">
                            </div>
                        </div>

                        <div class="space-y-3">
                            <button onclick="saveNewProfile()" class="btn-press w-full bg-slate-800 text-white py-3.5 rounded-2xl font-bold hover:bg-slate-900 transition-colors shadow-lg shadow-slate-200">Ø«Ø¨Øª Ù¾Ø±ÙˆÙ†Ø¯Ù‡</button>
                            <button onclick="closeModal()" class="btn-press w-full text-slate-400 py-2 text-sm font-bold hover:text-slate-600">Ø§Ù†ØµØ±Ø§Ù</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function saveNewProfile() {
            const nameEl = document.getElementById('new-profile-name');
            const ageEl = document.getElementById('new-profile-age');
            const name = nameEl ? nameEl.value.trim() : '';
            const age = ageEl ? parseInt(ageEl.value, 10) : NaN;
            if (!name) return showToast('Ù†Ø§Ù… Ø³Ø±Ø¨Ø§Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            if (!age || age <= 0) return showToast('Ø³Ù† Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

            state.profiles.push({ name, age, logs: [] });
            saveData();
            closeModal();
            renderProfiles(document.getElementById('app-container'));
            showToast('Ù¾Ø±ÙˆÙ†Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯ ØªØ´Ú©ÛŒÙ„ Ø´Ø¯');
        }

        // --- UTILS ---
        function showModal(content) {
            const overlay = document.getElementById('modal-overlay');
            const card = document.getElementById('modal-card');
            card.innerHTML = content;
            overlay.classList.remove('hidden');
            setTimeout(() => { 
                card.classList.remove('scale-95', 'opacity-0'); 
                card.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const card = document.getElementById('modal-card');
            card.classList.remove('scale-100', 'opacity-100');
            card.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                card.innerHTML = ''; 
            }, 300);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'scale-90');
            t.style.pointerEvents = 'auto';
            setTimeout(() => { t.classList.add('opacity-0', 'scale-90'); t.style.pointerEvents = 'none'; }, 3000);
        }

        function getCurrentTime() {
            const d = new Date();
            const hh = String(d.getHours()).padStart(2,'0');
            const mm = String(d.getMinutes()).padStart(2,'0');
            return `${hh}:${mm}`;
        }

        function getCurrentEvent() {
            const now = new Date();
            const nowMin = now.getHours() * 60 + now.getMinutes();
            let found = null;
            for (let i = 0; i < state.schedule.length; i++) {
                const itemMin = timeToMinutes(state.schedule[i].time);
                if (nowMin <= itemMin) { found = state.schedule[i]; break; }
            }
            return found || state.schedule[0] || { title: "ÙˆÙ‚Øª Ø¢Ø²Ø§Ø¯" };
        }

        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ù¾Ø±ÙˆØªÚ©Ù„ Ø¨Ù‡ Â«sectionsÂ» (Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ 4-ÙÛŒÙ„Ø¯ÛŒ Ù‡Ù…)
        function normalizeProtocolSections(result) {
            // ÙØ±Ù…Øª Ø¬Ø¯ÛŒØ¯
            if (result && Array.isArray(result.sections)) {
                return result.sections
                    .filter(x => x && (x.title || x.content))
                    .map(x => ({
                        title: String(x.title || '').trim(),
                        content: String(x.content || '').trim()
                    }))
                    .filter(x => x.title && x.content);
            }

            // ÙØ±Ù…Øª Ù‚Ø¯ÛŒÙ…ÛŒ (diagnosis/action/ammo/targeting)
            const legacy = [];
            if (result && (result.diagnosis || result.action || result.ammo || result.targeting)) {
                if (result.diagnosis) legacy.push({ title: "ØªØ´Ø®ÛŒØµ Ùˆ Ø±ÛŒØ´Ù‡â€ŒÛŒØ§Ø¨ÛŒ", content: String(result.diagnosis) });
                if (result.action) legacy.push({ title: "Ø§Ù‚Ø¯Ø§Ù… Ø¬Ù‡Ø§Ø¯ÛŒ ÙÙˆØ±ÛŒ", content: String(result.action) });
                if (result.ammo) legacy.push({ title: "Ø±Ø²Ù‚ Ù…Ø¹Ù†ÙˆÛŒ (Ø­Ø¯ÛŒØ«/Ù†Ú©ØªÙ‡)", content: String(result.ammo) });
                if (result.targeting) legacy.push({ title: "ØªÙ‚Ø³ÛŒÙ… Ø³Ù†Ú¯Ø± (Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ‡Ø§)", content: String(result.targeting) });
            }
            return legacy;
        }

        // Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ (Ù…Ø¯Ù„ Ø±Ù†Ú¯ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
        const PROTOCOL_SECTION_STYLES = [
            { border: "border-amber-500",   headBg: "bg-amber-50",   headText: "text-amber-800",   headBorder: "border-amber-100", icon: "ğŸ§­" },
            { border: "border-emerald-500", headBg: "bg-emerald-50", headText: "text-emerald-800", headBorder: "border-emerald-100", icon: "âš¡" },
            { border: "border-cyan-500",    headBg: "bg-cyan-50",    headText: "text-cyan-800",    headBorder: "border-cyan-100", icon: "ğŸ’" },
            { border: "border-rose-500",    headBg: "bg-rose-50",    headText: "text-rose-800",    headBorder: "border-rose-100", icon: "ğŸ¯" },
            { border: "border-indigo-500",  headBg: "bg-indigo-50",  headText: "text-indigo-800",  headBorder: "border-indigo-100", icon: "ğŸ›¡ï¸" },
            { border: "border-orange-500",  headBg: "bg-orange-50",  headText: "text-orange-800",  headBorder: "border-orange-100", icon: "ğŸ”¥" }
        ];

        function windowExpose() {
            Object.assign(window, {
                router,
                generateProtocol,
                openSettingsModal,
                addScheduleItem,
                updateSchedule,
                deleteSchedule,
                openAddProfileModal,
                saveNewProfile,
                updateLog,
                deleteLog,
                addLog,
                deleteProfile,
                analyzeProfile,
                saveSettings,
                refreshPrompts,
                closeModal,
                resetFactory,
                executeConfirm,
                switchSettingsTab,
                clearLogs,
                exportLogs,
                refreshLogsView
            });
        }

        // Init
        windowExpose();
        log('success', 'System', 'Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯ âœ¨');
        router('home');

    </script>
</body>
</html>